<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>IOS音频录制 | 徐子超的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="IOS 音频录制 — AVFoundation我们已经讲解了视频的录制所需要使用的一些API以及方式方法，都是建立在AVFoundation框架基础上，这次我们继续讲解此框架基础上的音频录制。一般场景有录制语音并播放；当静音开关被关闭的时候，音频怎么播放；当闹钟和手机电话响起的时候，音频播放做什么样的处理等等，整个交互都将使用到 AVAudioSession ，打通音频硬件设备到软件数据流的关键。">
<meta property="og:type" content="article">
<meta property="og:title" content="IOS音频录制">
<meta property="og:url" content="http://xuzichao.com/2015/02/01/IOS音频录制 --- AVFoundation/index.html">
<meta property="og:site_name" content="徐子超的博客">
<meta property="og:description" content="IOS 音频录制 — AVFoundation我们已经讲解了视频的录制所需要使用的一些API以及方式方法，都是建立在AVFoundation框架基础上，这次我们继续讲解此框架基础上的音频录制。一般场景有录制语音并播放；当静音开关被关闭的时候，音频怎么播放；当闹钟和手机电话响起的时候，音频播放做什么样的处理等等，整个交互都将使用到 AVAudioSession ，打通音频硬件设备到软件数据流的关键。">
<meta property="og:image" content="http://xuzichao.com/assets/images/aspg_intro_2x.png">
<meta property="og:image" content="http://xuzichao.com/assets/images/1.pic.jpg">
<meta property="og:image" content="http://xuzichao.com/assets/images/2.pic.jpg">
<meta property="og:image" content="http://xuzichao.com/assets/images/3.pic.jpg">
<meta property="og:image" content="http://xuzichao.com/assets/images/audio_route_change_2x.png">
<meta property="og:updated_time" content="2016-06-07T13:00:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IOS音频录制">
<meta name="twitter:description" content="IOS 音频录制 — AVFoundation我们已经讲解了视频的录制所需要使用的一些API以及方式方法，都是建立在AVFoundation框架基础上，这次我们继续讲解此框架基础上的音频录制。一般场景有录制语音并播放；当静音开关被关闭的时候，音频怎么播放；当闹钟和手机电话响起的时候，音频播放做什么样的处理等等，整个交互都将使用到 AVAudioSession ，打通音频硬件设备到软件数据流的关键。">
<meta name="twitter:image" content="http://xuzichao.com/assets/images/aspg_intro_2x.png">
  
    <link rel="alternative" href="/atom.xml" title="徐子超的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/photo.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?0b8e8ee87e4708173f00d9048c309301";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/assets/photo.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">卡图睡不醒</a></h1>
		</hgroup>

		
		<p class="header-subtitle">程先生，你好。客气，叫我序员吧。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="weibo" target="_blank" href="http://weibo.com/2356167600/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="weibo">weibo</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/zichao.xu.5" title="facebook">facebook</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/时光相册/" style="font-size: 15px;">时光相册</a> <a href="/tags/程序开发/" style="font-size: 20px;">程序开发</a> <a href="/tags/随笔小结/" style="font-size: 10px;">随笔小结</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">IOS开发,毕业于华中科技大学,今日头条在职</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">卡图睡不醒</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/assets/photo.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">卡图睡不醒</h1>
			</hgroup>
			
			<p class="header-subtitle">程先生，你好。客气，叫我序员吧。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="weibo" target="_blank" href="http://weibo.com/2356167600/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="weibo">weibo</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/zichao.xu.5" title="facebook">facebook</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-IOS音频录制 --- AVFoundation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/01/IOS音频录制 --- AVFoundation/" class="article-date">
  	<time datetime="2015-02-01T11:09:59.000Z" itemprop="datePublished">Feb 1</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      IOS音频录制
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="IOS-音频录制-—-AVFoundation"><a href="#IOS-音频录制-—-AVFoundation" class="headerlink" title="IOS 音频录制 — AVFoundation"></a>IOS 音频录制 — AVFoundation</h2><p>我们已经讲解了视频的录制所需要使用的一些API以及方式方法，都是建立在AVFoundation框架基础上，这次我们继续讲解此框架基础上的音频录制。一般场景有录制语音并播放；当静音开关被关闭的时候，音频怎么播放；当闹钟和手机电话响起的时候，音频播放做什么样的处理等等，整个交互都将使用到 AVAudioSession ，打通音频硬件设备到软件数据流的关键。</p>
<p><img src="/assets/images/aspg_intro_2x.png" alt=""></p>
<h2 id="一、概念引导"><a href="#一、概念引导" class="headerlink" title="一、概念引导"></a>一、概念引导</h2><h3 id="1、创建Audio-Session"><a href="#1、创建Audio-Session" class="headerlink" title="1、创建Audio Session"></a>1、创建Audio Session</h3><p>当你的APP启动之后，你就获得了一个单利的session,通过它你可以决定音乐上的各种使用场景，可以配置音频录制的参数，直接连接音频硬件。</p>
<p>1) 默认行为 （AVAudioSessionCategorySoloAmbient）</p>
<p>可以回放，关闭录制，静音键关闭则音量播放关闭，锁屏时候音量关闭，当其他音量想起，你的播放直接关闭。</p>
<p>当你开始录制的时候，你的session在运行，结束后你可以关闭，能够自己忽略的播放系统运行api的有<system sound="" services="" reference="">和<audio ui="" sounds="">。</audio></system></p>
<p>2) 合并行为AVCaptureSession</p>
<p>AVCaptureSession AVCaptureDevice在录制视频的时候也是一起录制了音频的，这是因为AVCaptureSession会默认的配置AVAudioSession，我们可以通过设置automaticallyConfiguresApplicationAudioSession为NO，然后自己去配置AVAudioSession。</p>
<p>3）MPVolumeView</p>
<p>为用户显示一个滑块控件设置系统音频输出音量和一个按钮选择音频输出路线。当第一次显示,滑块的位置反映了当前系统音频输出音量，当用户拖动滑块,体积变化更新，如果用户按下设备播放时,声音音量按钮滑块移动到反映新的体积。</p>
<p>4）一般方法举例：</p>
<ul>
<li>sharedInstance</li>
</ul>
<ul>
<li>otherAudioPlaying</li>
<li>requestRecordPermission</li>
<li>availableCategories</li>
<li>setActive:error:</li>
</ul>
<h3 id="2、使用类别Categories"><a href="#2、使用类别Categories" class="headerlink" title="2、使用类别Categories"></a>2、使用类别Categories</h3><p>1) 行为类别分布：</p>
<p>类作为一个关键值，定义了一组app的音频行为。苹果在iOS的未来版本可能细化分类行为。你最好的策略是选择最准确地描述了你的意图的类别音频你想要的行为，它们都遵循“last in wins” 规则。<br><img src="/assets/images/1.pic.jpg" alt=""></p>
<p>2）选用特殊话的模式</p>
<ul>
<li>AVAudioSessionModeVoiceChat—For Voice over IP (VoIP) apps</li>
<li>AVAudioSessionModeVideoChat—For video chat apps such as FaceTime</li>
<li>AVAudioSessionModeGameChat—For game apps</li>
<li>AVAudioSessionModeVideoRecording—For apps that use the camera to capture video</li>
<li>AVAudioSessionModeMoviePlayback—For apps that play movies.</li>
<li>AVAudioSessionModeMeasurement—For apps that processing to input and output signals.</li>
</ul>
<p><img src="/assets/images/2.pic.jpg" alt=""></p>
<h3 id="3、响应中断事件"><a href="#3、响应中断事件" class="headerlink" title="3、响应中断事件"></a>3、响应中断事件</h3><p>中断事件可以来自电话、闹钟、日历提醒、siri等。</p>
<p>1) 响应的处理过程：</p>
<p><img src="/assets/images/3.pic.jpg" alt=""></p>
<p>2）监听响应的方式：</p>
<ul>
<li><p>AVAudioSession 通知</p>
<p>  AVAudioSessionInterruptionNotification<br>AVAudioSessionRouteChangeNotification<br>AVAudioSessionMediaServicesWereLostNotification<br>AVAudioSessionMediaServicesWereResetNotification<br>AVAudioSessionSilenceSecondaryAudioHintNotification</p>
</li>
<li><p>AV Foundation framework</p>
<p>  AVAudioPlayer如果正在音频播放过程中可以有对应的代理来接收事件，AVAudioPlayerDelegate,同样也有对应的AVAudioRecorderDelegate ，都显示IOS8以后废弃掉。</p>
</li>
<li><p>Audio Queue Services, I/O audio unit</p>
</li>
<li>OpenAL ，Notification</li>
<li><p>System Sound Services</p>
<p>  发生则直接静音，中断终止可以重新再次播放，无需额外处理。</p>
</li>
</ul>
<h3 id="4、优化硬件音频数据"><a href="#4、优化硬件音频数据" class="headerlink" title="4、优化硬件音频数据"></a>4、优化硬件音频数据</h3><ul>
<li>指定首选硬件设置采样率和I / O的缓冲时间</li>
<li>查询许多硬件特征,其中包括输入和输出延迟,输入和输出通道数,硬件采样率、硬件体积设定,是否可用的音频输入应对设备具体通知最常用的属性值更改事件路线变化,覆盖在应对变化。</li>
<li>编写回调侦听硬件输出音量的变化和变化的可用性的音频输入。</li>
</ul>
<h3 id="5、响应路线变化"><a href="#5、响应路线变化" class="headerlink" title="5、响应路线变化"></a>5、响应路线变化</h3><p>作为您的应用程序运行时,用户可能插入或拔掉耳机,或者使用接上音频连接等，通过注册AVAudioSessionRouteChangeNotification通知去响应。<br><img src="/assets/images/audio_route_change_2x.png" alt=""></p>
<h3 id="6、调整音频会话的球员"><a href="#6、调整音频会话的球员" class="headerlink" title="6、调整音频会话的球员"></a>6、调整音频会话的球员</h3><p>从用户的音乐播放音频库以及你自己的声音，多个播放器混合播放。针对游戏App、音频记录播放App、VOIP聊天App、音频计量App等，要随时切换和配置类型。</p>
<h2 id="2、代码实践"><a href="#2、代码实践" class="headerlink" title="2、代码实践"></a>2、代码实践</h2><blockquote>
<h3 id="import-“TTAudioPlayer-h”"><a href="#import-“TTAudioPlayer-h”" class="headerlink" title="#import “TTAudioPlayer.h”"></a>#import “TTAudioPlayer.h”</h3><h3 id="import-“TTAudioRecorder-h”"><a href="#import-“TTAudioRecorder-h”" class="headerlink" title="#import “TTAudioRecorder.h”"></a>#import “TTAudioRecorder.h”</h3></blockquote>
<h2 id="3、问题回顾"><a href="#3、问题回顾" class="headerlink" title="3、问题回顾"></a>3、问题回顾</h2><h3 id="1、WAV转化AMR声音变形："><a href="#1、WAV转化AMR声音变形：" class="headerlink" title="1、WAV转化AMR声音变形："></a>1、WAV转化AMR声音变形：</h3><h4 id="现象："><a href="#现象：" class="headerlink" title="现象："></a>现象：</h4><p>录制WAV格式本地正常播放，转化为AMR后，把AMR格式文件在电脑端播放，声音严重变形，无法识别，再转化会WAV,，手机还是无法识别。</p>
<h4 id="原因与解决"><a href="#原因与解决" class="headerlink" title="原因与解决"></a>原因与解决</h4><p>声音格式转化采用的是#include “amrFileCodec.h”，一个第三方常用转化库libopencore，并且没有找到第二个转化库，它对转化的音频输入源是有格式要求的，要求转化的采样率为标准的8k，如果录制的音频频率采用高频率44.1K的话就会出现变形，我想这里的设定依据来自于amr格式的采样率为8K。</p>
<p>AMR格式：</p>
<blockquote>
<p>维基百科    </p>
<p>采样率 8 kHz/13-bit (160 采样点每20ms)，滤波后只保留 200-3400 Hz 范围内的信号.</p>
<p>编码器使用8个位速：12.2、10.2、7.95、7.40、6.70、5.90、5.15和4.75 kbit/s.</p>
</blockquote>
<p>amrFileCodec_h:</p>
<blockquote>
<p>#define AMR_MAGIC_NUMBER “#!AMR\n”</p>
<p>#define PCM_FRAME_SIZE 160 // 8khz 8000*0.02=160</p>
<p>#define MAX_AMR_FRAME_SIZE 32</p>
<p>#define AMR_FRAME_COUNT_PER_SECOND 50</p>
</blockquote>
<h3 id="2、先转后播一直长时间等待："><a href="#2、先转后播一直长时间等待：" class="headerlink" title="2、先转后播一直长时间等待："></a>2、先转后播一直长时间等待：</h3><h4 id="现象：-1"><a href="#现象：-1" class="headerlink" title="现象："></a>现象：</h4><p>界面UI点击播放之后，一直处于播放状态但是没有声音。</p>
<h4 id="原因与解决-1"><a href="#原因与解决-1" class="headerlink" title="原因与解决"></a>原因与解决</h4><ul>
<li>UI状态显示问题，与AUDIO有一个实际的播放误差，以为需要等待一段的转化时间，但实际上以及音频已经播放失败，导致多次重复点击，最后界面显示一直未播放中，但实际上，音频本身早就停止播放，这是由于对界面事件响应以及player实际播放状态判断的不完整导致。</li>
<li>网络错误请求，音频数据的源的请求返回错误，UI显示为在播放，实际返回错误。这与服务端有关系，经抓包查实，同样参数同样网络的相同请求有可能出现成功和失败两种结果。</li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/12/2016高考毕业生本科专业选择推荐/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          2016高考毕业生本科专业选择推荐
        
      </div>
    </a>
  
  
    <a href="/2015/01/28/IOS视频录制--AVFoudation/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">IOS视频录制</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="IOS音频录制 --- AVFoundation" data-title="IOS音频录制" data-url="http://xuzichao.com/2015/02/01/IOS音频录制 --- AVFoundation/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"catoo-hexo"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 卡图睡不醒
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: undefined,
		animate: undefined,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






  </div>
</body>
</html>