<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>徐子超的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="徐子超的博客">
<meta property="og:url" content="http://xuzichao.com/index.html">
<meta property="og:site_name" content="徐子超的博客">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="徐子超的博客">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="徐子超的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/photo.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?0b8e8ee87e4708173f00d9048c309301";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/assets/photo.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">东境</a></h1>
		</hgroup>

		
		<p class="header-subtitle">毕业于华中科技大学，今日头条在职</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/litten" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2356167600/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="weibo">weibo</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/zichao.xu.5" title="facebook">facebook</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/时光相册/" style="font-size: 10px;">时光相册</a> <a href="/tags/程序开发/" style="font-size: 20px;">程序开发</a> <a href="/tags/随笔小结/" style="font-size: 10px;">随笔小结</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">东境</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/assets/photo.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">东境</h1>
			</hgroup>
			
			<p class="header-subtitle">毕业于华中科技大学，今日头条在职</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/litten" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2356167600/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="weibo">weibo</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/zichao.xu.5" title="facebook">facebook</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-将机器学习模型转化为CoreML格式 " class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/06/将机器学习模型转化为CoreML格式 /" class="article-date">
  	<time datetime="2017-06-06T04:42:52.000Z" itemprop="datePublished">Jun 6</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/06/将机器学习模型转化为CoreML格式 /">将机器学习模型转化为CoreML格式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="将机器学习模型转化为CoreML格式"><a href="#将机器学习模型转化为CoreML格式" class="headerlink" title="将机器学习模型转化为CoreML格式"></a>将机器学习模型转化为CoreML格式</h3><blockquote>
<p>接上篇：机器学习在IOS开发中的应用 CoreML</p>
</blockquote>
<h2 id="四、创建自己的Core-Ml-Model"><a href="#四、创建自己的Core-Ml-Model" class="headerlink" title="四、创建自己的Core Ml Model"></a>四、创建自己的Core Ml Model</h2><h3 id="4-1-Apple支持的模型"><a href="#4-1-Apple支持的模型" class="headerlink" title="4.1 Apple支持的模型"></a>4.1 Apple支持的模型</h3><p>苹果支持由第三方工具和框架训练出来的机器学习模型转化，我们可以只用苹果提供的转化工具,将个人已经训练好的数据模型转化为CoreML进行支持。工具为 Core ML Tools ，是基于Python开发的工具，需要自己安装配置，到这里，上面一二节的概念理解就有作用了，前面提到了机器学习所使用到的思想算法，这里工具有对应的类型支持转化。我从官网对照理解过来如下图：</p>
<table>
<thead>
<tr>
<th>学习模型</th>
<th>子算法类型</th>
<th>工具框架</th>
</tr>
</thead>
<tbody>
<tr>
<td>人工神经网络</td>
<td>多层向前反馈网络（Multilayer Feedforward Network）、CNN卷积神经网络（Convolution Neural Network、RNN递归神经网络（Recurrent Neural Networks）</td>
<td>Caffe、Keras 1.2.2</td>
</tr>
<tr>
<td>集成算法</td>
<td>随机森林（Random forests）、迭代树（boosted trees）、决策树（decision trees）</td>
<td>scikit-learn 0.18、XGBoost 0.6</td>
</tr>
<tr>
<td>支持向量机</td>
<td>线性回归（Scalar regression）、多分类器（multiclass classification）</td>
<td>scikit-learn 0.18、LIBSVM 3.22</td>
</tr>
<tr>
<td>广义线性模型</td>
<td>线性回归（Linear regression）、多分类器（multiclass classification）、标量回归（Scalar regression）</td>
<td>scikit-learn 0.18</td>
</tr>
<tr>
<td>特征工程</td>
<td>稀疏向量化（Sparse vectorization）、密集向量化（ dense vectorization）、分类处理（categorical processing）</td>
<td>scikit-learn 0.18</td>
</tr>
<tr>
<td>机器学习流</td>
<td>马尔可夫链（Sequentially chained models）</td>
<td>scikit-learn 0.18</td>
</tr>
</tbody>
</table>
<h3 id="4-2-转换你的学习模型"><a href="#4-2-转换你的学习模型" class="headerlink" title="4.2 转换你的学习模型"></a>4.2 转换你的学习模型</h3><h2 id="五、时光相册的机器学习"><a href="#五、时光相册的机器学习" class="headerlink" title="五、时光相册的机器学习"></a>五、时光相册的机器学习</h2><h2 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h2><p>从本次实践看来..</p>
<p>写本文的目的不仅仅是对WWDC新技术的探索和分享，更是自己对机器学习的兴趣，搜索查询完成IOS的demo测试，完成本篇的时候，我对机器学习有了基础的认识，仿佛有了一种貌似学完python就能转行的自信，😀，加油吧，少年。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-机器学习在IOS开发中的应用 CoreML" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/05/机器学习在IOS开发中的应用 CoreML/" class="article-date">
  	<time datetime="2017-06-05T04:42:52.000Z" itemprop="datePublished">Jun 5</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/05/机器学习在IOS开发中的应用 CoreML/">机器学习在IOS开发中的应用 CoreML</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="机器学习在IOS开发中的应用-CoreML"><a href="#机器学习在IOS开发中的应用-CoreML" class="headerlink" title="机器学习在IOS开发中的应用 CoreML"></a>机器学习在IOS开发中的应用 CoreML</h3><blockquote>
<p>前言：2017年的WWDC大会苹果赋予了开发者们新能力，能够将机器学习应用在移动端上，这着实是一次让人感到兴奋的事情，一颗赛艇有木有！！积极开展的Session学习活动，本篇在第一节和第二节引用了一些概念和背景来帮助理解，熟练工请忽略，跳至第三节直接开始操作，本文同时请教了时光相册的同事，完成了在图片学习的demo。</p>
</blockquote>
<h2 id="一、AI-ML-DL"><a href="#一、AI-ML-DL" class="headerlink" title="一、AI.ML.DL"></a>一、AI.ML.DL</h2><h3 id="1、-人工智能"><a href="#1、-人工智能" class="headerlink" title="1、 人工智能"></a>1、 人工智能</h3><h4 id="1-1-定义："><a href="#1-1-定义：" class="headerlink" title="1.1 定义："></a>1.1 定义：</h4><p>让人工制造出来的系统或者机器，其运作行为看起来就像是人所表现出的智能行为一样，即机器“像人一样思考”、“像人一样行动”、“理性地思考”和“理性地行动”。人工智能的研究是高度技术性和专业的，比如机器学习就是属于学习方向的课题，让机器具有人一样的学习行为。</p>
<h4 id="1-2-研究课题："><a href="#1-2-研究课题：" class="headerlink" title="1.2 研究课题："></a>1.2 研究课题：</h4><p>演绎推理和解决问题、知识表示法、规划、学习、自然语言处理、运动和控制、知觉、社交、创造力、多元智能、伦理管理、经济冲击</p>
<h3 id="2、机器学习"><a href="#2、机器学习" class="headerlink" title="2、机器学习"></a>2、机器学习</h3><h4 id="2-1-定义："><a href="#2-1-定义：" class="headerlink" title="2.1 定义："></a>2.1 定义：</h4><p>通过在大量数据中寻找模式,从数据中自动分析获得规律，并利用规律对未知数据进行预测的算法.因为学习算法中涉及了大量的统计学理论，机器学习与推断统计学联系尤为密切，也被称为统计学习理论，涵盖一切有关数据训练的学习算法。</p>
<h4 id="2-2-方式分类："><a href="#2-2-方式分类：" class="headerlink" title="2.2 方式分类："></a>2.2 方式分类：</h4><ul>
<li>监督学习：</li>
</ul>
<p>从给定的训练数据集中学习出一个函数，当新的数据到来时，可以根据这个函数预测结果。监督学习的训练集要求是包括输入和输出，也可以说是特征和目标。训练集中的目标是由人标注的。类似概念还有半监督学习和无监督学习。</p>
<ul>
<li>增强学习：</li>
</ul>
<p>通过观察来学习做成如何的动作。每个动作都会对环境有所影响，学习对象根据观察到的周围环境的反馈来做出判断。 </p>
<h4 id="2-3-使用算法："><a href="#2-3-使用算法：" class="headerlink" title="2.3 使用算法："></a>2.3 使用算法：</h4><ul>
<li>构造间隔理论分布：聚类分析和模式识别</li>
</ul>
<p>人工神经网络<br>决策树<br>感知器<br>支持向量机<br>集成学习AdaBoost<br>降维与度量学习<br>聚类<br>贝叶斯分类器</p>
<ul>
<li>构造条件概率：回归分析和统计分类</li>
</ul>
<p>高斯过程回归<br>线性判别分析<br>最近邻居法<br>径向基函数核</p>
<ul>
<li>通过再生模型构造概率密度函数</li>
</ul>
<p>最大期望算法<br>概率图模型：包括贝叶斯网和Markov随机场<br>Generative Topographic Mapping</p>
<ul>
<li>近似推断技术：<br>马尔可夫链<br>蒙特卡罗方法<br>变分法</li>
</ul>
<p>苹果的 Core ML 框架支持神经网络、树组合、支持向量机、广义线性模型、特征工程和流水线模型</p>
<h3 id="3、深度学习"><a href="#3、深度学习" class="headerlink" title="3、深度学习"></a>3、深度学习</h3><h4 id="3-1-定义："><a href="#3-1-定义：" class="headerlink" title="3.1 定义："></a>3.1 定义：</h4><p>深度学习是机器学习中一种基于对数据进行表征学习的方法，起源于人工神经网络，在前期机器学习并没有深度学习这样的学习模型。所以我们现在也认为它是属于深度学习属于机器学习范畴内。它试图使用包含复杂结构或由多重非线性变换构成的多个处理层对数据进行高层抽象的算法。</p>
<h4 id="3-2-关系图："><a href="#3-2-关系图：" class="headerlink" title="3.2 关系图："></a>3.2 关系图：</h4><p><img src="/assets/images/AIMLDL.jpg" alt=""></p>
<h2 id="二、机器学习的应用发展："><a href="#二、机器学习的应用发展：" class="headerlink" title="二、机器学习的应用发展："></a>二、机器学习的应用发展：</h2><h3 id="2-1-发展："><a href="#2-1-发展：" class="headerlink" title="2.1  发展："></a>2.1  发展：</h3><p>1956年，达特茅斯会议提出了“人工智能”的概念。其后，人工智能就一直萦绕于人们的脑海之中，并在科研实验室中慢慢孵化。之后的几十年，人工智能一直在两极反转，或被称作人类文明耀眼未来的预言；或者被当成技术疯子的狂想扔到垃圾堆里，直到2012年之前，这两种声音还在同时存在。主要问题来自于运算需求难以得到满足，即使是最基本的神经网络，也需要大量的运算。过去几年，尤其是2015年以来，人工智能开始大爆发，很大一部分是由于GPU的广泛应用，使得并行计算变得更快、更便宜、更有效。当然，无限拓展的存储能力和骤然爆发的数据洪流（大数据）的组合拳，也使得图像数据、文本数据、交易数据、映射数据全面海量爆发。</p>
<h3 id="2-2-应用："><a href="#2-2-应用：" class="headerlink" title="2.2 应用："></a>2.2 应用：</h3><ul>
<li>领域列举</li>
</ul>
<p>机器学习已广泛应用于数据挖掘、计算机视觉、自然语言处理、生物特征识别、搜索引擎、医学诊断、检测信用卡欺诈、证券市场分析、DNA序列测序、语音和手写识别、战略游戏和机器人等等</p>
<ul>
<li>场景举例</li>
</ul>
<p>句子翻译、动态手势识别、个人化推荐、美化的图像处理、云歌曲推荐、无人机航拍的视频实时分类路况信息等等</p>
<h3 id="2-3-大公司"><a href="#2-3-大公司" class="headerlink" title="2.3 大公司"></a>2.3 大公司</h3><ul>
<li>FaceBook</li>
</ul>
<p>Facebook AI研究项目（FAIR）专注于基础科学以及长期研究,另外一个叫应用机器学习部门（AML）,将技术用于现有Facebook产品。</p>
<ul>
<li>Microsoft</li>
</ul>
<p>微软1991年就已经开始涉足机器学习，有数百名科学家和工程师。</p>
<ul>
<li>Google</li>
</ul>
<p>Google Assistant是谷歌深度学习研究的集大成者。</p>
<ul>
<li>Amazon</li>
</ul>
<p>其CEO贝索斯称，已经悄悄研究了AI四年，目前在其语音识别生态系统上投入的人力有1000人。</p>
<ul>
<li>Baidu</li>
</ul>
<p>2014年，百度重金挖来谷歌深度学习项目负责人Andrew Ng，发力AI研究。</p>
<ul>
<li>Apple</li>
</ul>
<p>WWDC2017，苹果宣布面向开发者的机器学习框架Core ML ，加速在 iPhone、iPad、Apple Watch 上的人工智能任务。</p>
<h2 id="三、在IOS中使用机器学习"><a href="#三、在IOS中使用机器学习" class="headerlink" title="三、在IOS中使用机器学习"></a>三、在IOS中使用机器学习</h2><blockquote>
<p>使用Core ML，你可以将训练好的机器学习模型整合到你的应用中。</p>
</blockquote>
<h3 id="3-1-Core-ML简介"><a href="#3-1-Core-ML简介" class="headerlink" title="3.1 Core ML简介"></a>3.1 Core ML简介</h3><p>Core ML是一个训练好的模型Model，一个机器学习算法应用到一个训练数据集之后所得到的结果。利用该模型可以基于新的输入数据而进行预测，也就是利用了机器学习的结果。比如，如果一个模型在一个地区的历史房价数据上进行了训练，那么它就可能能够根据房子的卧室和浴室数量来预测房价。</p>
<p>Core ML 为设备性能进行了优化，从而减少了内存占用和功耗。严格在设备上运行能够确保用户数据的隐私，并且能保证你的应用在没有网络连接时也能够工作和响应。</p>
<p>Core ML 框架本身构建于低层面的原语（primitives）之上，比如 Accelerate、BNNS 和 Metal Performance Shaders；</p>
<p>构建完成的Core Ml又作为其他更高级框架的基础，比如支持用于图像分析的 Vision 框架，用于自然语言处理的 Foundation类，以及用于评估已经学习到的决策树的 GameplayKit。结构图如下:</p>
<p><img src="/assets/images/CoreMl.png" alt=""></p>
<h3 id="3-2-如何获得CoreMl-Model"><a href="#3-2-如何获得CoreMl-Model" class="headerlink" title="3.2 如何获得CoreMl Model"></a>3.2 如何获得CoreMl Model</h3><p>从如上定义看出，CoreMl框架只是将机器学习后的成果拿来应用，本身并不涉及机器学习的运行环境和过程。获得这些结果的方式有两种。</p>
<ul>
<li><p>苹果爸爸为你提供的现在model<br>根据自己的需要下载：<a href="https://developer.apple.com/machine-learning" target="_blank" rel="external">https://developer.apple.com/machine-learning</a></p>
</li>
<li><p>自己创建model<br>苹果爸爸为开发者提供了生成方法，不满意官方或者使用不足的时候，可以自己去机器学习完成，在创建应用，即第四节的内容。</p>
</li>
</ul>
<h3 id="3-3-将CoreML模型用在你的应用中"><a href="#3-3-将CoreML模型用在你的应用中" class="headerlink" title="3.3 将CoreML模型用在你的应用中"></a>3.3 将CoreML模型用在你的应用中</h3><ul>
<li><p>新建demo工程，在工程target中在Build Phase的Link Binary With Libraries里，加上CoreML.framework系统框架。</p>
</li>
<li><p>将获得的 CoreMl Model 添加至工程中，我们以GoogLeNetPlaces.mlmodel为例:</p>
</li>
</ul>
<p><img src="/assets/images/GoogLeNetPlaces.png" alt=""></p>
<ul>
<li>注意中间有个Model Class ，点击查看api调用，有两点注意，输入参数为 CVPixelBufferRef 格式,图片需要是224X224像素的大小，所以需要自己写方法去转化为合适的参数。</li>
</ul>
<p><img src="/assets/images/GoogleAPI.jpg" alt=""></p>
<ul>
<li>调用示例</li>
</ul>
<blockquote>
<pre><code>GoogLeNetPlaces *model = [[GoogLeNetPlaces alloc] init];
UIImage *scaledImage = [self imageScaleToSize224:CGSizeMake(224, 224)];
CVPixelBufferRef buffer = [self pixelBufferFromImage:scaledImage];
GoogLeNetPlacesInput *input = [[GoogLeNetPlacesInput alloc] initWithSceneImage:buffer];
GoogLeNetPlacesOutput *output = [model predictionFromFeatures:input error:nil];
NSLog(@&quot;Scene label is: %@&quot;, output.sceneLabel);
</code></pre></blockquote>
<ul>
<li><p>结论</p>
<p>百度搜索图片，下载常规的桌子、卧室图片，利用google此个model进行判断输出，正确。输入健身房的图片，判断输出为博物馆。由此可以看出，训练样本过少，当输入数据变复杂的时候就不能判断正确，侧面激励开发者们自己开展训练模型。</p>
</li>
</ul>
<blockquote>
<p>本篇续文：将机器学习模型转化为CoreML格式 </p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-使用CocoaPods创建私有仓库" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/22/使用CocoaPods创建私有仓库/" class="article-date">
  	<time datetime="2016-11-22T11:09:59.000Z" itemprop="datePublished">Nov 22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/22/使用CocoaPods创建私有仓库/">使用CocoaPods创建私有仓库</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CocoaPods创建私有仓库"><a href="#CocoaPods创建私有仓库" class="headerlink" title="CocoaPods创建私有仓库"></a>CocoaPods创建私有仓库</h1><h2 id="一、两个概念："><a href="#一、两个概念：" class="headerlink" title="一、两个概念："></a>一、两个概念：</h2><h3 id="1、XXX-podspec-配置文件"><a href="#1、XXX-podspec-配置文件" class="headerlink" title="1、XXX.podspec   配置文件"></a>1、XXX.podspec   配置文件</h3><p>spec 配置文件是cocoapods的每一个代码仓库所对应的信息管理文件，主要是对仓库的行为进行配置，每一个版本的代码仓库都对应有一个配置文件。</p>
<p>包括仓库的名称、版本号、描述、主页地址、证书说明、作者、版本指定方式、工程的目标版本号、文件和资源的路径、依赖的库关系等。举例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be sure to run `pod lib lint ios-category.podspec' to ensure this is a</span></span><br><span class="line"><span class="comment"># valid spec before submitting.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Any lines starting with a # are optional, but their use is encouraged</span></span><br><span class="line"><span class="comment"># To learn more about a Podspec see http://guides.cocoapods.org/syntax/podspec.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Pod::Spec.<span class="keyword">new</span> <span class="keyword">do</span> |s|</span><br><span class="line">  s.name             = <span class="string">'ios-category'</span></span><br><span class="line">  s.version          = <span class="string">'0.0.2'</span></span><br><span class="line">  s.summary          = <span class="string">'ios-category is used for ios-network'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This description is used to generate tags and improve search results.</span></span><br><span class="line"><span class="comment">#   * Think: What does it do? Why did you write it? What is the focus?</span></span><br><span class="line"><span class="comment">#   * Try to keep it short, snappy and to the point.</span></span><br><span class="line"><span class="comment">#   * Write the description between the DESC delimiters below.</span></span><br><span class="line"><span class="comment">#   * Finally, don't worry about the indent, CocoaPods strips it!</span></span><br><span class="line"></span><br><span class="line">  s.description      = &lt;&lt;-DESC</span><br><span class="line"></span><br><span class="line">  s.homepage         = <span class="string">'http://www.example.com'</span></span><br><span class="line">  <span class="comment"># s.screenshots     = 'www.example.com/screenshots_1', 'www.example.com/screenshots_2'</span></span><br><span class="line">  s.license          = &#123; :type =&gt; <span class="string">'MIT'</span>, :file =&gt; <span class="string">'LICENSE'</span> &#125;</span><br><span class="line">  s.author           = &#123; <span class="string">'xuzichao'</span> =&gt; <span class="string">'xuzichao03@gmail.com'</span> &#125;</span><br><span class="line">  s.source           = &#123; :git =&gt; <span class="string">'git@code.xuzichao.org:tt_pods_ios-category.git'</span>, :tag =&gt; s.version.to_s  &#125;</span><br><span class="line">  <span class="comment"># s.social_media_url = 'https://twitter.com/&lt;TWITTER_USERNAME&gt;'</span></span><br><span class="line"></span><br><span class="line">  s.ios.deployment_target = <span class="string">'6.0'</span></span><br><span class="line"></span><br><span class="line">  s.source_files = <span class="string">'ios-category/Classes/**/*'</span></span><br><span class="line">  </span><br><span class="line">  s.resource_bundles = &#123;</span><br><span class="line">    <span class="string">'ios-category'</span> =&gt; [<span class="string">'ios-category/Resources/*'</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># s.public_header_files = 'Pod/Classes/**/*.h'</span></span><br><span class="line">  <span class="comment"># s.frameworks = 'UIKit', 'MapKit'</span></span><br><span class="line">  <span class="comment"># s.dependency 'ios-categorying', '~&gt; 2.3'</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="2、Spec-repo"><a href="#2、Spec-repo" class="headerlink" title="2、Spec repo"></a>2、Spec repo</h3><p>组合词，表示仓库的概念，主要是用于存储pod代码库对应的podspec文件，管理各个仓库的各个版本的代码，它其实就是一个容器。Cocoapods会默认在本地建立一个容器，包含了你各个工程对应的代码仓库，当你使用了Cocoapods后，它们就会被clone到本地的~/.cocoapods/repos目录下。这里指代的是Cocoapods默认创建的仓库，其实我们不需要关心。</p>
<p>当我们创建私有库的时候，我们需要有自己的容器，用于存放自己的各个代码库，和上面的Cocoapods创建的是区别开的。我们自己创建的容器，其实就是一个远端的git仓库，我们把代码库对应的各个版本配置文件提交上去。</p>
<h2 id="二、创建的操作："><a href="#二、创建的操作：" class="headerlink" title="二、创建的操作："></a>二、创建的操作：</h2><h3 id="1、使用cocoapods："><a href="#1、使用cocoapods：" class="headerlink" title="1、使用cocoapods："></a>1、使用cocoapods：</h3><p>1.1 命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo gem <span class="keyword">install</span> cocoapods</span><br><span class="line">touch podfile</span><br><span class="line">pod <span class="keyword">install</span></span><br><span class="line">pod <span class="keyword">update</span></span><br></pre></td></tr></table></figure>
<p>1.2 pod install 、 pod update</p>
<p>pod install 将pod的版本写入Podfile.lock文件中.对于已经在Podfile.lock中有记录的Pod下载对应的版本，即便有新的版本，也不会去更新.对于没有记录的，根据Podfile中的约定，下载版本，并把版本信息写入Podfile.lock中.</p>
<p>只有当需要更新pod版本时，才用pod update,其余时间都用pod install</p>
<h3 id="2、私有库"><a href="#2、私有库" class="headerlink" title="2、私有库"></a>2、私有库</h3><p>2.1 创建并设置一个私有的Spec Repo。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>pod repo add TestSpecs <span class="symbol">https:</span>/<span class="regexp">/coding.net/test</span>.git</span><br></pre></td></tr></table></figure>
<p>2.2 创建Pod的所需要的项目工程文件，并且有可访问的项目版本控制地址。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>git add .</span><br><span class="line"><span class="variable">$ </span>git commit -s -m <span class="string">"我的工程代码文件"</span></span><br><span class="line"><span class="variable">$ </span>git remote add origin git<span class="variable">@coding</span>.<span class="symbol">net:</span>ios-category.git     </span><br><span class="line"><span class="variable">$ </span>git push origin master</span><br></pre></td></tr></table></figure>
<p>2.3 创建Pod所对应的podspec文件。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod <span class="keyword">spec</span> create ios-category.podspec</span><br></pre></td></tr></table></figure>
<p>2.4 本地测试配置好的podspec文件是否可用。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pod <span class="class"><span class="keyword">lib</span> <span class="title">lint</span></span></span><br><span class="line">	</span><br><span class="line">$ pod <span class="string">'ios-category'</span>, :podspec =&gt; <span class="string">'~/Users/ios-category.podspec'</span>  <span class="comment">#指定podspec文件</span></span><br></pre></td></tr></table></figure>
<p>2.5 向私有的Spec Repo中提交podspec。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pod</span> repo <span class="keyword">push </span>TestSpecs ios-category.podspec</span><br></pre></td></tr></table></figure>
<p>2.6 在个人项目中的Podfile中增加刚刚制作的好的Pod并使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># private</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">'https://coding.net/test.git'</span></span><br><span class="line"><span class="comment"># public</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">'https://github.com/CocoaPods/Specs.git'</span></span><br><span class="line"></span><br><span class="line">target <span class="string">'ReactiveCocoaDemo'</span> <span class="keyword">do</span></span><br><span class="line">pod <span class="string">"ios-category"</span>, <span class="string">"0.1.0"</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="三、其他说明"><a href="#三、其他说明" class="headerlink" title="三、其他说明"></a>三、其他说明</h2><p>按照阶段二进行操作，即可顺利完成pod工程的引用，其他介绍说明文档中可能出现的，testpod 工程，其实可以不用管。比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod spec create PodTestLibrary git<span class="meta">@coding</span>.<span class="string">net:</span>test.gitt</span><br></pre></td></tr></table></figure>
<p>以及由于pod的各个版本变化，spec文件有可能本来是正确的，但是pod lib lint这一步始终不能通过，这样pod repo push这一步就无法完成。可以直接将spec文件通过git 提交的方式放进远端的Spec Repo中，依然可以正常运行。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-今日头条IOS热修复解决方案" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/11/今日头条IOS热修复解决方案/" class="article-date">
  	<time datetime="2016-09-11T14:59:12.000Z" itemprop="datePublished">Sep 11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/11/今日头条IOS热修复解决方案/">今日头条IOS热修复解决方案</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="TTSparkRescue"><a href="#TTSparkRescue" class="headerlink" title="TTSparkRescue"></a>TTSparkRescue</h1><blockquote>
<p>备注：2017年4月开始出现使用热修复审核不通过的情况，经过混淆的方式后，绕过了苹果的检测，但是到5月初的时候，苹果全方面严打IOS热修复策略，各方APP包括头条在内的方案被迫下架。</p>
</blockquote>
<h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h1><p>TTSparkRescue是头条公司层面的通用的热修复库，同时提供给其他产品线使用。设计包括如下：</p>
<ul>
<li>启动崩溃计数修改为3秒后清除</li>
<li>启动初始化的预清理</li>
<li>启动崩溃本地有缓存预先执行</li>
<li>启动崩溃第二次，启动上报逻辑和预处理</li>
<li>启动崩溃第三次，开始启动修复逻辑</li>
<li>启动后修复</li>
<li>补丁下发更新机制</li>
<li>客户端本地处理下发的patch错误</li>
<li>下发JS空白</li>
<li>下发前，本地预先运行，验证JS脚本</li>
<li>本地模拟crash</li>
<li>管理的系统版本号粒度更精细</li>
<li>增加端监控，传出参数，由TTMonitor在外部配合调到 </li>
</ul>
<h1 id="2-快速集成"><a href="#2-快速集成" class="headerlink" title="2. 快速集成"></a>2. 快速集成</h1><h2 id="2-1-Podfile引用"><a href="#2-1-Podfile引用" class="headerlink" title="2.1 Podfile引用"></a>2.1 Podfile引用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> <span class="string">'头条内部的git地址'</span></span><br><span class="line"></span><br><span class="line">pod <span class="string">'TTSparkRescue'</span>, <span class="string">'2.3'</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2-代码块替换"><a href="#2-2-代码块替换" class="headerlink" title="2.2 代码块替换"></a>2.2 代码块替换</h2><blockquote>
<p>方法A: </p>
</blockquote>
<p>APP原本的didFinishLaunchingWithOptions的全部逻辑didFinishLaunchingWithOptions</p>
<blockquote>
<p>方法B :</p>
</blockquote>
<p>新建并复制，参数和函数体与方法A保持一致</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(BOOL)</span>application:<span class="params">(UIApplication *)</span>application</span><br><span class="line"> normalLaunchProcessWithOptions:<span class="params">(NSDictionary *)</span>launchOptions</span><br></pre></td></tr></table></figure>
<p>使用TTJSPatch结构替换方法A，下面部分可以直接复制即可用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) wself = <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    <span class="comment">//默认注释关闭</span></span><br><span class="line">    <span class="comment">//    [[TTSparkRescue shareInstance] setTestPatch:YES simulationCrash:YES];</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//内部监控上报</span></span><br><span class="line">    [[TTSparkRescue shareInstance] setReportBlock:^(<span class="built_in">NSString</span> *key, <span class="built_in">NSDictionary</span> *info) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//crash的预处理逻辑</span></span><br><span class="line">        <span class="keyword">if</span> ([key isEqualToString:TTJSPatchLaunchCrash]) &#123;</span><br><span class="line">            <span class="comment">//优先清理coredata缓存</span></span><br><span class="line">            <span class="comment">//解决可能造成的crash</span></span><br><span class="line">            <span class="comment">//连续崩溃第四次才启用安全模式</span></span><br><span class="line">        &#125;</span><br><span class="line">        [[TTMonitor shareManager] trackService:key status:<span class="number">1</span> extra:info];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//运行错误处理，内部已加监控, type == 1 for JS, type == 2 for OC</span></span><br><span class="line">    [[TTSparkRescue shareInstance] setJSCrashHanlder:^(<span class="built_in">NSInteger</span> type, <span class="built_in">NSString</span> *msg) &#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//CompletionBlock:头条正常启动逻辑</span></span><br><span class="line">    [[TTSparkRescue shareInstance] setBoolCompletionBlock:^<span class="built_in">BOOL</span>&#123;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">        <span class="comment">//本地测试的时候模拟crash，不必注释，由前面的开关控制即可</span></span><br><span class="line">        [[TTSparkRescue shareInstance] simulationLauchCrash];</span><br><span class="line">        [[TTSparkRescue shareInstance] simulationLauchDelayCrash];</span><br><span class="line">        [[TTSparkRescue shareInstance] simulationActiveCrash];</span><br><span class="line">        </span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [wself application:application normalLaunchProcessWithOptions:launchOptions];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//启动执行逻辑，完成后调用CompletionBlock</span></span><br><span class="line">    <span class="keyword">return</span> [[TTSparkRescue shareInstance] launchContinuousCrashProcess];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-功能设计"><a href="#3-功能设计" class="headerlink" title="3. 功能设计"></a>3. 功能设计</h1><h2 id="3-1、说明："><a href="#3-1、说明：" class="headerlink" title="3.1、说明："></a>3.1、说明：</h2><h4 id="1、启动崩溃计数修改为12秒后清除"><a href="#1、启动崩溃计数修改为12秒后清除" class="headerlink" title="1、启动崩溃计数修改为12秒后清除"></a>1、启动崩溃计数修改为12秒后清除</h4><blockquote>
<p>如果启动过程中，出现延迟操作，操作时间在原先的5秒之外，那么这次操作如果出现崩溃将无法被记录下。也就无法再启动中修复。<br>     将清除时间调大，设置为一个网络请求的返回时间，覆盖了延迟造作造成的crash。</p>
</blockquote>
<h4 id="2、启动初始化的预清理"><a href="#2、启动初始化的预清理" class="headerlink" title="2、启动初始化的预清理"></a>2、启动初始化的预清理</h4><blockquote>
<p>当我们判断当前版本号发生变化时，直接清除本地的patch文件，避免升级覆盖安装后，还持有原先逻辑或者错误。</p>
</blockquote>
<h4 id="3、启动崩溃本地有缓存预先执行"><a href="#3、启动崩溃本地有缓存预先执行" class="headerlink" title="3、启动崩溃本地有缓存预先执行"></a>3、启动崩溃本地有缓存预先执行</h4><blockquote>
<p>因为是修复崩溃的逻辑，之前需要达到崩溃条件后才开始请求下发，原本就体验差了，如果再遇上网络缓慢的时候，启动会很慢，<br>  体验更差。并且每次都会崩溃后重新启动。此次修改后，出现一次之后同步请求返回patch,正常启动，下次进入，判断有缓存就直接执行，<br>  执行异步的请求更新。</p>
</blockquote>
<h4 id="4、启动崩溃第二次，启动上报逻辑和预处理"><a href="#4、启动崩溃第二次，启动上报逻辑和预处理" class="headerlink" title="4、启动崩溃第二次，启动上报逻辑和预处理"></a>4、启动崩溃第二次，启动上报逻辑和预处理</h4><blockquote>
<p>APPDelegate 上报和预处理逻辑 ReportBlock，当出现第二次崩溃的时候，可以删除本地的一些可能会导致crash的东西，<br>比如本地的数据库可以先清理掉，等等。然后统计上报。</p>
</blockquote>
<h4 id="5、启动崩溃第三次，开始启动修复逻辑"><a href="#5、启动崩溃第三次，开始启动修复逻辑" class="headerlink" title="5、启动崩溃第三次，开始启动修复逻辑"></a>5、启动崩溃第三次，开始启动修复逻辑</h4><blockquote>
<p>如果本地有缓存，则网络异步更新，因为后面的逻辑保证本地已有的缓存patchJS执行没错，所以可以先执行。<br>如果本地无缓存，则网络同步请求，返回补丁，运行成功后再启动APP正常流程。<br>不会再出现再次崩溃3此的情况。<br>只要出现3次崩溃，忽略本地缓存，直接请求更新。</p>
</blockquote>
<h4 id="6、启动后修复"><a href="#6、启动后修复" class="headerlink" title="6、启动后修复"></a>6、启动后修复</h4><blockquote>
<p>启动中的时候，判断本地有缓存文件，预先执行，之后，每次active就会请求更新文件</p>
</blockquote>
<h4 id="7、补丁下发更新机制"><a href="#7、补丁下发更新机制" class="headerlink" title="7、补丁下发更新机制"></a>7、补丁下发更新机制</h4><blockquote>
<p>本地无缓存，直接存储，有缓存，判断版本号。<br> 我们在后台下发补丁的时候，目前依旧保持，升级版本号，全量覆盖。也就是说，app每个版本，在客户端里依旧保持唯一一个补丁，启动前和启动后各自有对应的唯一一个。<br>此处，服务端也有策略，我们上传的参数包含当前，版本，如果服务端有更高版本，就会升级。</p>
</blockquote>
<h4 id="8、客户端本地处理下发的patch错误"><a href="#8、客户端本地处理下发的patch错误" class="headerlink" title="8、客户端本地处理下发的patch错误"></a>8、客户端本地处理下发的patch错误</h4><blockquote>
<ul>
<li>(void)handleException:(void (^)(NSInteger crashType,NSString *msg))exceptionBlock;<br>crashType == 1 的时候是 JS环境 运行的Crash<br>crashType == 2 的时候是  OC环境 运行的Crash<br>当我们下发的脚本有问题的时候，客户端本地直接删除全部补丁文件，包括启动前和启动后。<br>APPDelegate 中 JSCrashHanlder 被调用，可以填写上报逻辑和反馈运行的错误原因。<br>在此条件下，当用户退到后台之后，自动崩溃，重新打开客户端没有patch，这个留出来及时下发修正后Patch的时机。</li>
</ul>
</blockquote>
<h4 id="9、下发JS空白"><a href="#9、下发JS空白" class="headerlink" title="9、下发JS空白"></a>9、下发JS空白</h4><blockquote>
<p>直接删除本地补丁文件</p>
</blockquote>
<h4 id="10、下发前，本地预先运行，验证JS脚本"><a href="#10、下发前，本地预先运行，验证JS脚本" class="headerlink" title="10、下发前，本地预先运行，验证JS脚本"></a>10、下发前，本地预先运行，验证JS脚本</h4><blockquote>
<p>直接将要在后台要下发的JS代码，非BASE64编码，贴到工程里的test.js 文件里，此处文件名固定。<br>并在APPDelegate 打开测试运行的开关，然后直接运行即可，测试完毕，防止错误，必须关闭。</p>
</blockquote>
<h4 id="11、本地模拟crash"><a href="#11、本地模拟crash" class="headerlink" title="11、本地模拟crash"></a>11、本地模拟crash</h4><blockquote>
<p>增加错误的OC代码导致crash，用于模拟各种情况，包括启动中，启动中延时，启动后。<br>并设置了开关，默认都是关闭的，随测试方法的开关一起，正式提交时，必须关闭。</p>
</blockquote>
<h4 id="2、管理的系统版本号粒度更精细"><a href="#2、管理的系统版本号粒度更精细" class="headerlink" title="2、管理的系统版本号粒度更精细"></a>2、管理的系统版本号粒度更精细</h4><blockquote>
<p>整数示例：8，9，10   —-   后台命中：8.x,9.x,10.x   IOS系统版本<br>精确示例：9.1.2 — 后台命中：9.1.2 IOS系统版本</p>
</blockquote>
<h4 id="13、下发补丁一并写注释"><a href="#13、下发补丁一并写注释" class="headerlink" title="13、下发补丁一并写注释"></a>13、下发补丁一并写注释</h4><blockquote>
<p>每次下发补丁，需要填写说明，包括：【事故原因】【下发人】【下发日期】</p>
</blockquote>
<h4 id="14、启动后的下发调用改为通知"><a href="#14、启动后的下发调用改为通知" class="headerlink" title="14、启动后的下发调用改为通知"></a>14、启动后的下发调用改为通知</h4><blockquote>
<p>不需要在applicationDidBecomeActive中再显示调用原来的makePatchRequestAfterLaunch，manager内部监听通知即可。</p>
</blockquote>
<h4 id="15、增加端监控，传出参数，由TTMonitor在外部配合调到"><a href="#15、增加端监控，传出参数，由TTMonitor在外部配合调到" class="headerlink" title="15、增加端监控，传出参数，由TTMonitor在外部配合调到"></a>15、增加端监控，传出参数，由TTMonitor在外部配合调到</h4><blockquote>
<p>监控请求成功和失败、下发更新、版本升级删除的等等用于统计patch的使用情况，后期有利于生成分布和图形。<br>TTSparkRescueLaunchCrash<br>APPDelegate 上报和预处理逻辑 ReportBlock，当出现第二次崩溃的时候，可以删除本地的一些可能会导致crash的东西，<br>比如本地的数据库可以先清理掉，等等。然后统计上报。<br>TTSparkRescueServerCloseCrash<br>服务器端下发关闭运行JSPatch的统计<br>TTSparkRescueDeleteFile<br>删除清空本地文件的统计，下发空白、错误、运行错误、升级都会删除之前的缓存文件，用action字段区分。<br>TTSparkRescueError<br>内部运行的错误报告，文件请求失败和运行失败等。<br>TTSparkRescueUpdateFile<br>统计更新成功的事件</p>
</blockquote>
<h2 id="3-2、测试Case"><a href="#3-2、测试Case" class="headerlink" title="3.2、测试Case"></a>3.2、测试Case</h2><p>1、启动中，有崩溃，包括延时崩溃，无缓存文件。正常同步请求返回，APP启动完成。</p>
<p>2、启动中，有崩溃，包括延时崩溃，有缓存文件。<br>直接读取本地文件，APP启动完成。</p>
<p>3、启动中，有崩溃，包括延时崩溃，下发JS语法的patch文件。<br>无法正常启动，连续crash3次后走同步请求。</p>
<p>4、启动后，有崩溃，无缓存文件。正常异步请求返回，APP正常运行。</p>
<p>5、启动后，有崩溃，有缓存文件。直接读取本地文件，正常同步请求返回更新文件，APP正常运行。</p>
<p>6、启动后，下发错误JS语法的patch文件。客户端判断文件出错，删除全部补丁缓存文件，清零，开始重新请求更新。</p>
<p>7、以上case通过线上下发运行一次，再本地测试开关运行一次。testPatch.js 在主工程被正确添加后，都可以正确执行。</p>
<p>8、升级版本号，覆盖安装。删除本地原有的补丁文件，清零。</p>
<p>9、监控点事件上报。正常对外输出事件和外带信息到APPDelegate中</p>
<h1 id="4-使用说明"><a href="#4-使用说明" class="headerlink" title="4. 使用说明"></a>4. 使用说明</h1><h2 id="4-1-补丁后台管理"><a href="#4-1-补丁后台管理" class="headerlink" title="4.1 补丁后台管理"></a>4.1 补丁后台管理</h2><p>客户端的修复需要后端的支持，提供接口和后端管理平台，用于托管修复文件，控制版本和保证传输安全。客户端根据反馈的崩溃信息(版本、名称、设备、用户)，针对某一批用户或者某一个版本号，在后台进行选择对应的版本JS文件，进行下发即可。</p>
<h3 id="4-1-1-热修复接口定义"><a href="#4-1-1-热修复接口定义" class="headerlink" title="4.1.1 热修复接口定义"></a>4.1.1 热修复接口定义</h3><p>应用名称和应用ID作用一致，为了兼容老的已经发出去的版本，我们保留app_name，之后的都是用app_id，两者等效力，<br>参数命中其中一个，至少有一个就行，就可以返回值。  </p>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数ID</th>
<th>举例说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用版本号</td>
<td>app_version</td>
<td>5.6.0</td>
</tr>
<tr>
<td>应用名称</td>
<td>app_name</td>
<td>今日头条</td>
</tr>
<tr>
<td>应用ID</td>
<td>app_id</td>
<td>com.iphone.text</td>
</tr>
<tr>
<td>启动前后</td>
<td>app_launch</td>
<td>0前1后</td>
</tr>
<tr>
<td>设备ID</td>
<td>device_id</td>
<td>用户的手机设备ID</td>
</tr>
<tr>
<td>编号</td>
<td>无，客户端不作请求参数</td>
<td>服务端后台的文件号，随意定，不重复即可</td>
</tr>
<tr>
<td>百分比</td>
<td>无，客户端不作请求参数</td>
<td>服务端后台按量下发补丁</td>
</tr>
<tr>
<td>ON/OFF</td>
<td>无，客户端不作请求参数</td>
<td>服务端后台控制补丁开关</td>
</tr>
<tr>
<td>逗号分隔</td>
<td>无，客户端不作请求参数</td>
<td>服务端后台下发补丁，支持不同的版本，逗号分隔</td>
</tr>
<tr>
<td>应用版本号扩展</td>
<td>无，客户端不作请求参数</td>
<td>服务端后台下发的补丁，补丁本身的版本号，格式约定：应用版本号整数数字.补丁版本号整数数字，比如：570.1，591.21</td>
</tr>
</tbody>
</table>
<h3 id="4-1-2-数据格式"><a href="#4-1-2-数据格式" class="headerlink" title="4.1.2 数据格式"></a>4.1.2 数据格式</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="symbol">status:</span><span class="number">0</span>, </span><br><span class="line"><span class="symbol">message:</span><span class="string">""</span>,</span><br><span class="line"><span class="symbol">data:</span>&#123;</span><br><span class="line"><span class="symbol">     js_crash:</span><span class="number">0</span>,  <span class="comment">//修复代码本身出错的时候打开</span></span><br><span class="line"><span class="symbol">     js_version:</span><span class="number">560.4</span>,         <span class="comment">//5.6.0版本的第四个JS版本</span></span><br><span class="line"><span class="symbol">     js_value:</span> <span class="string">" sfkdsfnldjgdfnkgndkfngdsfgmdfngfjshdbfkhrwnf"</span>   <span class="comment">//js的BASE64编码值，客户端直接解码运行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-客户端运行："><a href="#4-2-客户端运行：" class="headerlink" title="4.2 客户端运行："></a>4.2 客户端运行：</h2><p>补丁分为启动前和启动后，和前面快速集成代码块一样，只需要这里，就已经是全部，启动前后的划分在内部执行，通知监听，不需要手动再调用。</p>
<h2 id="4-3、具体案例："><a href="#4-3、具体案例：" class="headerlink" title="4.3、具体案例："></a>4.3、具体案例：</h2><p>案例：5.7.0版本上bug修复</p>
<p>当我们需要完全替换方法的时候，我们需要注意替换原则，就是尽量使用原生的Native方法，这样JSpatch在转化的过程中可以遵循原生方法规则，生成对应代码，在解析的时候可以还原。<br>比如：</p>
<h3 id="4-3-1-使用注意"><a href="#4-3-1-使用注意" class="headerlink" title="4.3.1 使用注意"></a>4.3.1 使用注意</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> setAutoresizingMaskFlexibleWidthAndHeight(<span class="built_in">UIView</span> *view)&#123;</span><br><span class="line">    view.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span>|<span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setAutoresizingMaskFlexibleWidthAndHeight(self.footerView);<br>我们在写的时候得写成：<br>self.footerView.autoresizingMask = 2|16;<br>系统自定义的常量，比如：UIViewAutoresizingFlexibleWidth,在JSPtatch中将被转化为同名的变量，然而这个变量，却在JS环境中没有定义，从而会报错。<br>所以我们直接使用对应的常量数字 2.</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[[self.footerView footerScrollView]</span> <span class="selector-tag">tt_addDelegate</span><span class="selector-pseudo">:self</span> <span class="selector-tag">asMainDelegate</span><span class="selector-pseudo">:NO</span>];</span><br></pre></td></tr></table></figure>
<p>用于JSPatch自定义的语法为使用下划线区分方法名称，所以当转化为的JS再次被转回来OC方法的时候，会出现[[self.footerView footerScrollView] tt:addDelegate:self asMainDelegate:NO];<br>这样就崩溃了。</p>
<h3 id="4-3-2-示例"><a href="#4-3-2-示例" class="headerlink" title="4.3.2  示例"></a>4.3.2  示例</h3><p>Native源代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TTDetailWebviewContainer</span></span></span><br><span class="line">- (<span class="keyword">void</span>)addFooterView:(<span class="built_in">UIView</span>&lt;TTDetailFooterViewProtocol&gt; *)footerView</span><br><span class="line">  detailFooterAddType:(TTDetailNatantStyle)natantStyle</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.natantStyle = natantStyle;</span><br><span class="line">    <span class="keyword">self</span>.footerView = footerView;</span><br><span class="line">    [<span class="keyword">self</span>.footerView addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"footerScrollView"</span> options:<span class="built_in">NSKeyValueObservingOptionOld</span> | <span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line">    [[<span class="keyword">self</span>.footerView footerScrollView] tt_addDelegate:<span class="keyword">self</span> asMainDelegate:<span class="literal">NO</span>];</span><br><span class="line">    <span class="keyword">self</span>.footScrollView = <span class="keyword">self</span>.footerView.footerScrollView;</span><br><span class="line">    <span class="keyword">self</span>.footerView.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">    <span class="comment">//footerScrollView被赋值后，刷新scrollEnable和scrollToTop的状态；</span></span><br><span class="line">    <span class="keyword">self</span>.footerStatus = <span class="keyword">self</span>.footerStatus;</span><br><span class="line">    setAutoresizingMaskFlexibleWidthAndHeight(<span class="keyword">self</span>.footerView);</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> shouldOpenInsertionOptimization]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> addFooterView];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      [<span class="keyword">self</span> addFooterView];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>目标JS代码：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">defineClass</span>(<span class="string">'TTDetailWebviewContainer'</span>, &#123;</span><br><span class="line"><span class="attribute">addFooterView_detailFooterAddType</span>: function(footerView, natantStyle) &#123;</span><br><span class="line">self.setNatantStyle(natantStyle);</span><br><span class="line">self<span class="selector-class">.setFooterView</span>(footerView);</span><br><span class="line">self<span class="selector-class">.footerView</span>()<span class="selector-class">.addObserver_forKeyPath_options_context</span>(self, <span class="string">"footerScrollView"</span>, <span class="number">1</span>|<span class="number">2</span>, null);</span><br><span class="line">self<span class="selector-class">.footerView</span>()<span class="selector-class">.footerScrollView</span>()<span class="selector-class">.tt__addDelegate_asMainDelegate</span>(self, false);</span><br><span class="line">self<span class="selector-class">.setFootScrollView</span>(self.footerView().footerScrollView());</span><br><span class="line">self<span class="selector-class">.footerView</span>()<span class="selector-class">.setFrame</span>(self.bounds());</span><br><span class="line">self<span class="selector-class">.setFooterStatus</span>(self.footerStatus());</span><br><span class="line">self<span class="selector-class">.footerView</span>()<span class="selector-class">.setAutoresizingMask</span>(<span class="number">2</span> | <span class="number">16</span>);</span><br><span class="line"><span class="selector-tag">if</span> (self.shouldOpenInsertionOptimization()) &#123;</span><br><span class="line">self<span class="selector-class">.addFooterView</span>();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">self<span class="selector-class">.addFooterView</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="5-原理介绍"><a href="#5-原理介绍" class="headerlink" title="5. 原理介绍"></a>5. 原理介绍</h1><h2 id="5-1-三方库"><a href="#5-1-三方库" class="headerlink" title="5.1 三方库"></a>5.1 三方库</h2><p>JSPatch(Github链接)诞生于2015年5月，最初是腾讯广研高级iOS开发@bang的个人项目。在Github.com上开源后获得了几千个star和几百个fork，广受关注，目前已被应用在大量腾讯/阿里/百度的App中。只需要在项目里引入极小的引擎文件，就可以使用 JavaScript 调用任何 Objective-C 的原生接口，替换任意 Objective-C 原生方法。所以我们通过下发 JS 脚本替换原生 Objective-C 代码，就可以实时修复线上 bug。针对头条客户端用于解决客户端发布后的崩溃修复问题，尤其是解决客户端的启动崩溃问题。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="5-2-TTSparkRescue"><a href="#5-2-TTSparkRescue" class="headerlink" title="5.2 TTSparkRescue"></a>5.2 TTSparkRescue</h2><h3 id="5-2-1-修复类型"><a href="#5-2-1-修复类型" class="headerlink" title="5.2.1 修复类型"></a>5.2.1 修复类型</h3><h4 id="5-2-1-1-启动进行中"><a href="#5-2-1-1-启动进行中" class="headerlink" title="5.2.1.1 启动进行中"></a>5.2.1.1 启动进行中</h4><p>当发生启动崩溃的时候，通过同步的网络请求，下发JS脚本执行修复。下发的条件由本地的崩溃计数决定，应用每次启动都会在本地增加一次崩溃计数，并在3秒之后将计数清理，如果3秒内崩溃，则判定为一次真实的崩溃。当崩溃次数达到设置的条件的时候，比如连续崩溃3次，客户端就开始执行修复的逻辑过程，向后端发起对此接口的同步请求，由接口信息告知是否需要使用JS修复，是否需要更新JS文件，文件版本号以及JS文件内容的加密值。请求返回后，由客户端本地判断更新文件，下载，并执行。如果本地之前没有修复的JS 文件，默认需要请求更新。更新文件成功后，对应更新本地的文件版本号和MD5值。</p>
<p>同步请求：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_semaphore_t </span>semaphore = <span class="keyword">dispatch_semaphore_create(0);</span><br><span class="line"></span><span class="keyword">dispatch_queue_t </span>queue = <span class="keyword">dispatch_queue_create("queue", </span>NULL)<span class="comment">;</span></span><br><span class="line"><span class="keyword">dispatch_async(queue, </span>^(void) &#123;</span><br><span class="line">    </span><br><span class="line">    HandlerBlock semaphoreBlock = ^(TTSparkRescueCrashType type,NSString *msg)&#123;</span><br><span class="line">        <span class="keyword">dispatch_semaphore_signal(semaphore);</span><br><span class="line"></span>    &#125;<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    [self getLaunchRequestBlock:semaphoreBlock]<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">dispatch_semaphore_wait(semaphore, </span><span class="keyword">DISPATCH_TIME_FOREVER);</span></span><br></pre></td></tr></table></figure>
<p>请求返回保存本地</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>updateLaunchLocalJS:<span class="params">(NSString *)</span>launchJS</span><br><span class="line">                versionCode:<span class="params">(NSNumber *)</span>versionCode</span><br></pre></td></tr></table></figure>
<p>执行本地JS代码</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>exvalueBase64Script:<span class="params">(NSString *)</span>base64Script;</span><br><span class="line">- <span class="params">(void)</span>exvalueRescueScript:<span class="params">(NSString *)</span>jsScript;</span><br></pre></td></tr></table></figure>
<p>监听是否有执行错误</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>setJSCrashHanlder:<span class="params">(HandlerBlock)</span>handlerBlock;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-1-2-启动完成后，使用中"><a href="#5-2-1-2-启动完成后，使用中" class="headerlink" title="5.2.1.2 启动完成后，使用中"></a>5.2.1.2 启动完成后，使用中</h4><p>当到达启动崩溃条件的时候，我们直接执行启动热修复逻辑。启动的时间稍微加长，遇见网络慢的情况用户需要等待的时间就会更久，当然为了避免崩溃这都是必要的。还有，另外的情况是，当用户使用我们的应用的时候，在一个层级比较深的地方操作并出现崩溃，当用户用到这里之前才会崩溃都不会有，这种情况我们依然需要进行热修复。流程类似，为异步。</p>
<h3 id="5-2-2-补丁模拟自测"><a href="#5-2-2-补丁模拟自测" class="headerlink" title="5.2.2 补丁模拟自测"></a>5.2.2 补丁模拟自测</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"> *  测试环节，用一个方法控制开关</span><br><span class="line"> *  执行测试的testPatch.js,固定命名，测试完毕提交的时候必须关闭</span><br><span class="line"> *  模拟启动中崩溃,立刻</span><br><span class="line"> *  模拟启动中延迟崩溃，延迟启动中网络请求返回的默认时间10s</span><br><span class="line"> *  模拟激活后崩溃,60s</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">-<span class="ruby"> (void)<span class="symbol">setTestPatch:</span>(BOOL)testJsOn <span class="symbol">simulationCrash:</span>(BOOL)crashOn;</span><br><span class="line"></span>-<span class="ruby"> (void)simulationLauchCrash;</span><br><span class="line"></span>-<span class="ruby"> (void)simulationLauchDelayCrash;</span><br><span class="line"></span>-<span class="ruby"> (void)simulationActiveCrash;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-混淆方式，绕过审核"><a href="#5-2-2-混淆方式，绕过审核" class="headerlink" title="5.2.2 混淆方式，绕过审核"></a>5.2.2 混淆方式，绕过审核</h3><h4 id="5-2-2-1-原理："><a href="#5-2-2-1-原理：" class="headerlink" title="5.2.2.1 原理："></a>5.2.2.1 原理：</h4><p>我们大致判断，苹果审核部检测应用是否使用JSPatch是通过运行时方法名检测。所以通过宏定义替换的方式，我们将与”JSPatch“有关的字段都用混淆的字符串进行宏定义替换，运行时检测到的都是混淆的不可读名称。</p>
<h4 id="5-2-2-2-脚本替换"><a href="#5-2-2-2-脚本替换" class="headerlink" title="5.2.2.2 脚本替换"></a>5.2.2.2 脚本替换</h4><p>shell脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/env bash  </span><br><span class="line"> </span></span><br><span class="line">STRING_SYMBOL_FILE=<span class="string">"func.list"</span>  </span><br><span class="line">HEAD_FILE=<span class="string">"./confuseMacro.h"</span>  </span><br><span class="line"><span class="built_in">export</span> LC_CTYPE=C  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ramdomString</span></span>()  </span><br><span class="line">&#123;  </span><br><span class="line">    openssl rand -base64 64 | tr -cd <span class="string">'a-zA-Z'</span> |head -c 16  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">rm <span class="_">-f</span> <span class="variable">$HEAD_FILE</span>  </span><br><span class="line"></span><br><span class="line">touch <span class="variable">$HEAD_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'#ifndef Demo_codeObfuscation_h  </span><br><span class="line">#define Demo_codeObfuscation_h'</span> &gt;&gt; <span class="variable">$HEAD_FILE</span>  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"//confuse string at `date`"</span> &gt;&gt; <span class="variable">$HEAD_FILE</span>  </span><br><span class="line">cat <span class="string">"<span class="variable">$STRING_SYMBOL_FILE</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -ra line; <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">if</span> [[ ! -z <span class="string">"<span class="variable">$line</span>"</span> ]]; <span class="keyword">then</span>  </span><br><span class="line">        ramdom=`ramdomString`  </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$line</span> <span class="variable">$ramdom</span>  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"#define <span class="variable">$line</span> <span class="variable">$ramdom</span>"</span> &gt;&gt; <span class="variable">$HEAD_FILE</span>  </span><br><span class="line">    <span class="keyword">fi</span>  </span><br><span class="line"><span class="keyword">done</span>  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"#endif"</span> &gt;&gt; <span class="variable">$HEAD_FILE</span></span><br></pre></td></tr></table></figure>
<p>宏定义替换结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> Demo_codeObfuscation_h  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Demo_codeObfuscation_h</span></span><br><span class="line"><span class="comment">//confuse string at 2017年 5月 9日 星期二 15时09分20秒 CST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPEngine zLuEDxRvmBuomcFI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPExtension IoAZxAmFBjgEOaIg</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPBoxing wzZsoLGKuQUTRFsi</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> startEngine PRqvWWtwFlXUqdBe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evaluateScriptWithPath cNHrlJKiZyWXkfKo</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _evaluateScriptWithPath oDyiimPOHiIWBOEI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> addExtensions MbpkqoMunCfIBgxY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> defineStruct jIfCtJkMsIshJCvx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> formatPointerJSToOC IcHiIjXLjFucrQHR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> formatRetainedCFTypeOCToJS lyCjsaHwzQaYUiBE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> formatPointerOCToJS DdwjOGMUveuHjYQq</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> formatJSToOC BBFoPIaVlHRWBNQx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> formatOCToJS PHwNpfqmydeeFhMY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TTSparkRescue euibpyTZoKOvrKyO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> exvalueBase64Script fcXBLgUPqmsRqIWx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _JSOverideMethods FBOBELKtnClIUhEa</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _TMPMemoryPool ysvnOHCwoCVvFwfY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _propKeys cnyhVgwVNuEVAvEp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _JSMethodSignatureCache inrkXDymTFAbwLRo</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _JSMethodSignatureLock LmXaTYYBizrQBKzn</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _JSMethodForwardCallLock YdmfSXxrtNuKsJkp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _protocolTypeEncodeDict NxHWlKlDFjjgpzYV</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _pointersToRelease pybucmDygKyxFMvj</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> jp_methodSignatureForSelector cyzfrUQNsmWrwIgU</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> jp_fixMethodSignature vlSNUMpVTTXwTWJl</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPForwardInvocation gflqBWbUOmJHNfcL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JPExecuteORIGForwardInvocation itGMsXKksYYFyCPL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _initJPOverideMethods hpoUXLPSkKsFbHRk</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> overrideMethod KCgQjNlpCNXOixZS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> invokeVariableParameterMethod YITOuEIcAICefCkG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> convertJPSelectorString wwttXxSrZoFlmKML</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> getJSFunctionInObjectHierachy JjRtFUqUREPdZAgY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unboxOCObjectToJS MeVMxsEAmgCokbXc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> makePatchRequestAfterLaunch icreqUfezHNyjLdw</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> setJSCrashHanlder hwsfKTIzZPvTEMmc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> getLaunchPatchVersionCode jqRICpprUZpVeKVy</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> getActivePatchVersionCode zZIvunQsewkyABXu</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2016重庆高考毕业生本科专业选择推荐" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/12/2016重庆高考毕业生本科专业选择推荐/" class="article-date">
  	<time datetime="2016-06-12T11:09:59.000Z" itemprop="datePublished">Jun 12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/12/2016重庆高考毕业生本科专业选择推荐/">2016年重庆高考选择专业</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>普通高校本科专业选择推荐</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此文针对2016届高考毕业生就读普通大学本科专业推荐，推荐凭借自己的社会认识和对众多所在对应专业的同学学习从业动向判定而得，等高考成绩出来了，结合本省排名、个人意向、专业招生人数、专业往年招生分数，即可快速定位。本文是我表弟16年重庆高考结束，成绩还没出来前特意针对他个人给预备着的，所以带有些许的个人色彩。</p>
<p>徐子超 (<a href="http://xuzichao.com">http://xuzichao.com</a>)</p>
<p>2016.6.12</p>
<h2 id="可选专业"><a href="#可选专业" class="headerlink" title="可选专业"></a>可选专业</h2><h3 id="01学科门类：哲学-（所有门类不考虑）"><a href="#01学科门类：哲学-（所有门类不考虑）" class="headerlink" title="01学科门类：哲学 （所有门类不考虑）"></a>01学科门类：哲学 <font color="blue">（所有门类不考虑）</font></h3><h3 id="02学科门类：经济学-（所有门类可选）"><a href="#02学科门类：经济学-（所有门类可选）" class="headerlink" title="02学科门类：经济学  （所有门类可选）"></a>02学科门类：经济学  <font color="red">（所有门类可选）</font></h3><blockquote>
<p> 0201 经济学类 </p>
</blockquote>
<pre><code>* 020101 经济学

* 020102 经济统计学
</code></pre><blockquote>
<p>0202 财政学类</p>
</blockquote>
<pre><code>* 020201K 财政学

* 020202 税收学
</code></pre><blockquote>
<p>0203 金融学类</p>
</blockquote>
<pre><code>* 020301K 金融学

* 020302 金融工程

* 020303 保险学

* 020304 投资学
</code></pre><blockquote>
<p>0204 经济与贸易类</p>
</blockquote>
<pre><code>* 020401 国际经济与贸易

* 020402 贸易经济
</code></pre><h3 id="03学科门类：法学-（其他门类不考虑）"><a href="#03学科门类：法学-（其他门类不考虑）" class="headerlink" title="03学科门类：法学  （其他门类不考虑）"></a>03学科门类：法学  <font color="blue">（其他门类不考虑）</font></h3><blockquote>
<p>030101K 法学 <font color="red">（可选）</font></p>
</blockquote>
<h3 id="04学科门类：教育学-（所有门类不考虑）"><a href="#04学科门类：教育学-（所有门类不考虑）" class="headerlink" title="04学科门类：教育学  （所有门类不考虑）"></a>04学科门类：教育学  <font color="blue">（所有门类不考虑）</font></h3><h3 id="05学科门类：文学-（其他门类不考虑）"><a href="#05学科门类：文学-（其他门类不考虑）" class="headerlink" title="05学科门类：文学  （其他门类不考虑）"></a>05学科门类：文学  <font color="blue">（其他门类不考虑）</font></h3><blockquote>
<p>0502 外国语言文学类 <font color="red">（可选）</font></p>
<p>0503 新闻传播学类 <font color="red">（可选）</font></p>
</blockquote>
<pre><code>050301 新闻学

050302 广播电视学

050303 广告学

050304 传播学

050305 编辑出版学
</code></pre><h3 id="06学科门类：历史学-（所有门类不考虑）"><a href="#06学科门类：历史学-（所有门类不考虑）" class="headerlink" title="06学科门类：历史学  （所有门类不考虑）"></a>06学科门类：历史学  <font color="blue">（所有门类不考虑）</font></h3><h3 id="07学科门类：理学-（其他门类不考虑）"><a href="#07学科门类：理学-（其他门类不考虑）" class="headerlink" title="07学科门类：理学  （其他门类不考虑）"></a>07学科门类：理学  <font color="blue">（其他门类不考虑）</font></h3><blockquote>
<p>0701 数学类  <font color="red">（可选）</font></p>
</blockquote>
<pre><code>070101 数学与应用数学

070102 信息与计算科学
</code></pre><blockquote>
<p>0712 统计学类 <font color="red">（可选）</font></p>
</blockquote>
<pre><code>071201 统计学

071202 应用统计学
</code></pre><h3 id="08学科门类：工学-（全部门类可选，分程度）"><a href="#08学科门类：工学-（全部门类可选，分程度）" class="headerlink" title="08学科门类：工学 （全部门类可选，分程度）"></a>08学科门类：工学 <font color="red">（全部门类可选，分程度）</font></h3><blockquote>
<p>0801 力学类  <font color="green">（最后）</font></p>
</blockquote>
<pre><code>080101 理论与应用力学
</code></pre><blockquote>
<p>0802 机械类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>080201 机械工程

080202 机械设计制造及其自动化

080203 材料成型及控制工程

080204 机械电子工程

080205 工业设计

080206 过程装备与控制工程

080207 车辆工程

080208 汽车服务工程
</code></pre><blockquote>
<p>0803 仪器类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>080301 测控技术与仪器
</code></pre><blockquote>
<p>0804 材料类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>080401 材料科学与工程

080402 材料物理（注：可授工学或理学学士学位）

080403 材料化学（注：可授工学或理学学士学位）

080404 冶金工程

080405 金属材料工程

080406 无机非金属材料工程

080407 高分子材料与工程

080408 复合材料与工程
</code></pre><blockquote>
<p>0805 能源动力类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>080501 能源与动力工程
</code></pre><blockquote>
<p>0806 电气类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>080601 电气工程及其自动化
</code></pre><blockquote>
<p>0807 电子信息类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>080701 电子信息工程（注：可授工学或理学学士学位）

080702 电子科学与技术（注：可授工学或理学学士学位）

080703 通信工程

080704 微电子科学与工程（注：可授工学或理学学士学位）

080705光电信息科学与工程（注：可授工学或理学学士学位）

080706 信息工程
</code></pre><blockquote>
<p>0808 自动化类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>080801 自动化
</code></pre><blockquote>
<p>0809 计算机类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>080901 计算机科学与技术（注：可授工学或理学学士学位）

080902 软件工程

080903 网络工程

080904K 信息安全（注：可授工学或理学或管理学学士学位）

080905 物联网工程

080906 数字媒体技术
</code></pre><blockquote>
<p>0810 土木类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>081001 土木工程

081002 建筑环境与能源应用工程

081003 给排水科学与工程

081004 建筑电气与智能化
</code></pre><blockquote>
<p>0811 水利类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>081101 水利水电工程

081102 水文与水资源工程

081103 港口航道与海岸工程
</code></pre><blockquote>
<p>0812 测绘类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>081201 测绘工程

081202 遥感科学与技术
</code></pre><blockquote>
<p>0813 化工与制药类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>081301 化学工程与工艺

081302 制药工程
</code></pre><blockquote>
<p>0814 地质类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>081401 地质工程

081402 勘查技术与工程

081403 资源勘查工程
</code></pre><blockquote>
<p>0815 矿业类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>081501 采矿工程

081502 石油工程

081503 矿物加工工程

081504 油气储运工程
</code></pre><blockquote>
<p>0816 纺织类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>081601 纺织工程

081602 服装设计与工程（注：可授工学或艺术学学士学位）
</code></pre><blockquote>
<p>0817 轻工类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>081701 轻化工程

081702 包装工程

081703 印刷工程
</code></pre><blockquote>
<p>0818 交通运输类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>081801 交通运输

081802 交通工程

081803K 航海技术

081804K 轮机工程

081805K 飞行技术
</code></pre><blockquote>
<p>0819 海洋工程类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>081901 船舶与海洋工程
</code></pre><blockquote>
<p>0820 航空航天类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>082001 航空航天工程

082002 飞行器设计与工程

082003 飞行器制造工程

082004 飞行器动力工程

082005 飞行器环境与生命保障工程
</code></pre><blockquote>
<p>0821 兵器类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>082101 武器系统与工程

082102 武器发射工程

082103 探测制导与控制技术

082104 弹药工程与爆炸技术

082105 特种能源技术与工程

082106 装甲车辆工程

082107 信息对抗技术
</code></pre><blockquote>
<p>0822 核工程类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>082201 核工程与核技术

082202 辐射防护与核安全

082203 工程物理

082204 核化工与核燃料工程
</code></pre><blockquote>
<p>0823 农业工程类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>082301 农业工程

082302 农业机械化及其自动化

082303 农业电气化

082304 农业建筑环境与能源工程

082305 农业水利工程
</code></pre><blockquote>
<p>0824 林业工程类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>082401 森林工程

082402 木材科学与工程

082403 林产化工
</code></pre><blockquote>
<p>0825 环境科学与工程类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>082501 环境科学与工程

082502 环境工程

082503 环境科学（注：可授工学或理学学士学位）

082504 环境生态工程
</code></pre><blockquote>
<p>0826 生物医学工程类<font color="green">（最后）</font></p>
</blockquote>
<pre><code>082601 生物医学工程（注：可授工学或理学学士学位）
</code></pre><blockquote>
<p>0827 食品科学与工程类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>082701 食品科学与工程（注：可授工学或农学学士学位）

082702 食品质量与安全

082703 粮食工程

082704 乳品工程

082705 酿酒工程
</code></pre><blockquote>
<p>0828 建筑类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>082801 建筑学

082802 城乡规划

082803 风景园林（注：可授工学或艺术学学士学位）
</code></pre><blockquote>
<p>0829 安全科学与工程类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>082901 安全工程
</code></pre><blockquote>
<p>0830 生物工程类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>083001 生物工程
</code></pre><blockquote>
<p>0831 公安技术类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>083101K 刑事科学技术

083102K 消防工程
</code></pre><h3 id="09学科门类：农学-（所有门类不考虑）"><a href="#09学科门类：农学-（所有门类不考虑）" class="headerlink" title="09学科门类：农学 （所有门类不考虑）"></a>09学科门类：农学 <font color="blue">（所有门类不考虑）</font></h3><h3 id="10学科门类：医学-（所有门类可考虑，分程度）"><a href="#10学科门类：医学-（所有门类可考虑，分程度）" class="headerlink" title="10学科门类：医学 （所有门类可考虑，分程度）"></a>10学科门类：医学 <font color="red">（所有门类可考虑，分程度）</font></h3><blockquote>
<p>1001 基础医学类  <font color="green">（其次）</font></p>
</blockquote>
<pre><code>100101K 基础医学
</code></pre><blockquote>
<p>1002 临床医学类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>100201K 临床医学
</code></pre><blockquote>
<p>1003 口腔医学类 <font color="green">（优先）</font></p>
</blockquote>
<pre><code>100301K 口腔医学
</code></pre><blockquote>
<p>1004 公共卫生与预防医学类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>100401K 预防医学

100402 食品卫生与营养学
</code></pre><blockquote>
<p>1005 其次医学类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>100501K 其次医学

100502K 针灸推拿学

100503K 藏医学

100504K 蒙医学

100505K 维医学

100506K 壮医学

100507K 哈医学
</code></pre><blockquote>
<p>1006 其次西医结合类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>100601K 其次西医临床医学
</code></pre><blockquote>
<p>1007 药学类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code> 100701 药学

100702 药物制剂
</code></pre><blockquote>
<p>1008 其次药学类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>100801 其次药学

100802 其次药资源与开发
</code></pre><blockquote>
<p>1009 法医学类 <font color="green">（其次）</font></p>
<p>1010 医学技术类 <font color="green">（其次）</font></p>
</blockquote>
<pre><code>101001 医学检验技术

101002 医学实验技术

101003 医学影像技术

101004 眼视光学

101005 康复治疗学

101006 口腔医学技术

101007 卫生检验与检疫
</code></pre><blockquote>
<p>1011 护理学类 <font color="green">（最后）</font></p>
</blockquote>
<pre><code>101101 护理学
</code></pre><h3 id="12学科门类：管理学-（其他门类不考虑）"><a href="#12学科门类：管理学-（其他门类不考虑）" class="headerlink" title="12学科门类：管理学 （其他门类不考虑）"></a>12学科门类：管理学 <font color="blue">（其他门类不考虑）</font></h3><blockquote>
<p>1201 管理科学与工程类  <font color="red">（可选）</font></p>
</blockquote>
<pre><code>120101 管理科学

120102 信息管理与信息系统

120103 工程管理

120104 房地产开发与管理

120105 工程造价
</code></pre><blockquote>
<p>1202 工商管理类  <font color="red">（可选）</font></p>
</blockquote>
<pre><code>120201K 工商管理

120202 市场营销

120203K 会计学

120204 财务管理

120205 国际商务

120206 人力资源管理

120207 审计学

120208 资产评估
120209 物业管理

120210 文化产业管理
</code></pre><h3 id="13学科门类：艺术学-（其他门类不考虑）"><a href="#13学科门类：艺术学-（其他门类不考虑）" class="headerlink" title="13学科门类：艺术学   （其他门类不考虑）"></a>13学科门类：艺术学   <font color="blue">（其他门类不考虑）</font></h3><blockquote>
<p>1305 设计学类 <font color="red">（可选）</font></p>
</blockquote>
<pre><code>130501 艺术设计学

130502 视觉传达设计

130503 环境设计

130504 产品设计

130505 服装与服饰设计

130506 公共艺术

130507 工艺美术

130508 数字媒体艺术
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔小结/">随笔小结</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2016iweb 峰会" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/12/2016iweb 峰会/" class="article-date">
  	<time datetime="2016-05-12T11:09:59.000Z" itemprop="datePublished">May 12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/12/2016iweb 峰会/">参加Iweb峰会记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>16年的时候，赶上周末去参加了一趟北京的iweb峰会，会上来自各个公司的人分享和宣传自己的产品和技术，我作为一名普通开发者的角度去听大会，并了解和记录当前的一些技术发展。 </p>
</blockquote>
<h2 id="一、主题峰会-9-00-–-12-00"><a href="#一、主题峰会-9-00-–-12-00" class="headerlink" title="一、主题峰会 9:00 – 12:00"></a>一、主题峰会 9:00 – 12:00</h2><h4 id="1、主持人开场-–-田爱娜-HTML5梦工场-创始人"><a href="#1、主持人开场-–-田爱娜-HTML5梦工场-创始人" class="headerlink" title="1、主持人开场    – 田爱娜 HTML5梦工场  创始人"></a>1、主持人开场    – 田爱娜 HTML5梦工场  创始人</h4><p>HTML5梦工场是中国最有影响力的技术社区团队，由国内最早一批HTML5探索者和狂热拥护者发起，为广大开发者搭建一个开放、自由的互动交流平台，旨在推动HTML5在中国的应用与普及。“梦工场”也被誉为最接地气的草根公益组织。</p>
<h4 id="2、HTML5发行的力量-–-凌海-蝴蝶互动-CEO"><a href="#2、HTML5发行的力量-–-凌海-蝴蝶互动-CEO" class="headerlink" title="2、HTML5发行的力量    – 凌海  蝴蝶互动  CEO"></a>2、HTML5发行的力量    – 凌海  蝴蝶互动  CEO</h4><p>公司的创始人凌海、王峰都来自于中国互联网上市公司核心高管，有业界极为丰富的互联网产品经验和创新精神。凌海曾任盛大集团高级副总裁，盛大游戏总 裁，韩国上市公司ACTOZ董事长。王峰曾任盛大游戏技术副总裁。<br>《传世H5》工作室组建于2015年初，由策划团队、美术团队、技术研发团队、运营团队、测试团队等组成。<br>除了《传世H5》蝴蝶互动又相继推出了《鬼吹灯》、《天天赚钱》、《蛮荒创世》等优秀的HTML5游戏，收到用户和业界的不断好评，之后蝴蝶互动即将推出《武 神》、《鹿鼎记》等。</p>
<h4 id="3、天下武功，唯快不破-–-陈书艺-白鹭时代-CEO"><a href="#3、天下武功，唯快不破-–-陈书艺-白鹭时代-CEO" class="headerlink" title="3、天下武功，唯快不破 – 陈书艺 白鹭时代  CEO"></a>3、天下武功，唯快不破 – 陈书艺 白鹭时代  CEO</h4><p>白鹭移动游戏解决方案包含白鹭引擎、工具和白鹭开放平台，提供从游戏开发、上线到商业化运营的一站式免费服务。白鹭引擎（Egret Engine）、HTML5加速器(Egret Runtime)、骨骼动画工具(Dragon Bones)、可视化编辑器(Egret Wing)等共计14款核心产品，可以帮助开发者高效地开发出HTML5游戏。白鹭开放平台联动开发者、发行商、渠道商、第三方服务商，让HTML5游戏实现了从开发、上线到商业化运营生态连线，并且让所有技术服务和商业化服务，得以落地。案例：围住神经猫、访问量三天过亿</p>
<h4 id="4、-社交生态下的HTML5游戏新契-–-王哲-触控科技副总裁"><a href="#4、-社交生态下的HTML5游戏新契-–-王哲-触控科技副总裁" class="headerlink" title="4、    社交生态下的HTML5游戏新契 – 王哲 触控科技副总裁"></a>4、    社交生态下的HTML5游戏新契 – 王哲 触控科技副总裁</h4><p>公司起步于2008年初创建的CocoaChina社区，专注于苹果产品和iOS系统开发。2010年11月12日触控科技正式组建团队，并在之后2年间获得北极光、迪士尼思伟创投、红杉创投以及纪源资本（GGV）的风险投资，融资总规模3200万美金。2011年凭借一款《捕鱼达人》游戏一战成名。</p>
<h4 id="5、-HTML5和Docker容器如何重构和颠覆应用产业-–-李明-很快-创始人兼CEO"><a href="#5、-HTML5和Docker容器如何重构和颠覆应用产业-–-李明-很快-创始人兼CEO" class="headerlink" title="5、 HTML5和Docker容器如何重构和颠覆应用产业 – 李明 很快  创始人兼CEO"></a>5、 HTML5和Docker容器如何重构和颠覆应用产业 – 李明 很快  创始人兼CEO</h4><h4 id="6、WeX5移动开发云-马科-CEO"><a href="#6、WeX5移动开发云-马科-CEO" class="headerlink" title="6、WeX5移动开发云 马科 CEO"></a>6、WeX5移动开发云 马科 CEO</h4><p>WeX5开发H5 app，遵循Apache开源协议，完全开源免费，上百个组件框架，全部开放，可视化的组件框架，开发者可自定义组件，集成第三方组件，采用MVC设计模式，数据和视图分离，页面描述和代码逻辑分离，支持浏览器调试、真机调试、原生调试，等多种调试模式，开发者可掌握每一行代码。WeX5一直坚持采用H5+CSS3+JS标准技术，一次开发，多端任意部署.</p>
<h4 id="7、-Web-前端的实时化-–-江小丹-英特尔-Web技术研发总监"><a href="#7、-Web-前端的实时化-–-江小丹-英特尔-Web技术研发总监" class="headerlink" title="7、 Web 前端的实时化 – 江小丹 英特尔  Web技术研发总监"></a>7、 Web 前端的实时化 – 江小丹 英特尔  Web技术研发总监</h4><h4 id="8、移动互联网下半场，不用好HTML5将无法生存-–-肖光宇-野狗实时后端云-联合创始人"><a href="#8、移动互联网下半场，不用好HTML5将无法生存-–-肖光宇-野狗实时后端云-联合创始人" class="headerlink" title="8、移动互联网下半场，不用好HTML5将无法生存 – 肖光宇 野狗实时后端云  联合创始人"></a>8、移动互联网下半场，不用好HTML5将无法生存 – 肖光宇 野狗实时后端云  联合创始人</h4><p>实时通信—包括消息订阅，推送，双向通信等功能。网络延迟小，服务响应速度快，API简单易用。<br>数据存储—提供了一个Key-Value的云端数据存储，直接通过API就可以对数据进行存取操作。操作简单，按需扩展。</p>
<h4 id="9、-H5游戏进入精品新时代-—-王安-Dcloud-CEO"><a href="#9、-H5游戏进入精品新时代-—-王安-Dcloud-CEO" class="headerlink" title="9、 H5游戏进入精品新时代 — 王安 Dcloud CEO"></a>9、 H5游戏进入精品新时代 — 王安 Dcloud CEO</h4><p>DCloud面向HTML5行业分别推出了开发工具HBuilder、手机强化引擎5+ Runtime、跨平台前端框架mui、应用发行产品流应用，通过系列产品对HTML5的强化支持，使得HTML5能达到原生的功能和体验，同时在发行上更优于原生应用。</p>
<p>类似 : APICloud</p>
<h4 id="10-、谢成鸿-LayaBox-CEO"><a href="#10-、谢成鸿-LayaBox-CEO" class="headerlink" title="10 、谢成鸿 LayaBox  CEO"></a>10 、谢成鸿 LayaBox  CEO</h4><p>Layabox是HTML5引擎之一，引擎以HTML5技术为核心，定位于全平台的高性能引擎，让游戏开发者一次开发，可同时发布APP、HTML5、VR、Flash版本。开发语言支持Flash AS3、JavaScript、TypeScript三种，让开发者人才选择范围更广泛。引擎核心库仅100K左右，除了大型游戏和小型游戏、还可以用于HTML5应用、APP、广告、营销、教育、3D、VR等众多领域。另外，LayaPlayer运行器移动设备安装量覆盖超5亿，帮助Layabox引擎的开发者进行产品发行。<br>  Layabox是Laya中国实验室历经4年倾力打造的全球顶级HTML5技术框架，核心产品包括：Flash开发H5的框架（LayaFlash）、多语言H5开发引擎（LayaAir）、H5运行器（LayaPlayer）、嵌入式H5应用商店（LayaStore）。</p>
<h2 id="二、应用工具专场1-13：30-–-17：00"><a href="#二、应用工具专场1-13：30-–-17：00" class="headerlink" title="二、应用工具专场1 13：30 – 17：00"></a>二、应用工具专场1 13：30 – 17：00</h2><h4 id="1、HTML5-App开发云实践-基于完全开源的WeX5开发框架"><a href="#1、HTML5-App开发云实践-基于完全开源的WeX5开发框架" class="headerlink" title="1、HTML5 App开发云实践-基于完全开源的WeX5开发框架"></a>1、HTML5 App开发云实践-基于完全开源的WeX5开发框架</h4><p>王洁 WeX5  首席技术运营</p>
<h4 id="2、-Web技术推进多样化人机交互方式"><a href="#2、-Web技术推进多样化人机交互方式" class="headerlink" title="2、 Web技术推进多样化人机交互方式"></a>2、 Web技术推进多样化人机交互方式</h4><p>吴栋霞 英特尔  软件工程师</p>
<h4 id="3、-Yo-去哪儿移动UI框架"><a href="#3、-Yo-去哪儿移动UI框架" class="headerlink" title="3、 Yo-去哪儿移动UI框架"></a>3、 Yo-去哪儿移动UI框架</h4><p>杜瑶 去哪儿网  前端开发总监</p>
<h4 id="4、-手机QQ-React-Web极致优化"><a href="#4、-手机QQ-React-Web极致优化" class="headerlink" title="4、 手机QQ React Web极致优化"></a>4、 手机QQ React Web极致优化</h4><p>李成熙 腾讯AlloyTeam  前端工程师</p>
<h4 id="5、-手机淘宝营销互动页面最佳实践"><a href="#5、-手机淘宝营销互动页面最佳实践" class="headerlink" title="5、 手机淘宝营销互动页面最佳实践"></a>5、 手机淘宝营销互动页面最佳实践</h4><p>黄华健  阿里巴巴  前端工程师</p>
<h4 id="6、大型SPA的复杂工程如何化简"><a href="#6、大型SPA的复杂工程如何化简" class="headerlink" title="6、大型SPA的复杂工程如何化简"></a>6、大型SPA的复杂工程如何化简</h4><p>陈恺睿 小米  高级前端工程师</p>
<h4 id="7、-UC前端业务套件体系"><a href="#7、-UC前端业务套件体系" class="headerlink" title="7、 UC前端业务套件体系"></a>7、 UC前端业务套件体系</h4><p>三桥 阿里巴巴UC移动事业群  高级前端工程师</p>
<h2 id="三、应用工具专场2-13：30-–-17：00"><a href="#三、应用工具专场2-13：30-–-17：00" class="headerlink" title="三、应用工具专场2 13：30 – 17：00"></a>三、应用工具专场2 13：30 – 17：00</h2><h4 id="1、Web-Components-—-Web-前端开发的未来趋势"><a href="#1、Web-Components-—-Web-前端开发的未来趋势" class="headerlink" title="1、Web Components — Web 前端开发的未来趋势"></a>1、Web Components — Web 前端开发的未来趋势</h4><p>1、陈本峰 云适配  创始人兼CEO</p>
<p>云适配由前微软美国总部专家、美通云动（北京）科技公司CEO陈本峰在美国西雅图研发，只需在原网站中插入一行代码，即能创建移动化网站，并实现网址不变、内容实时更新，它颠覆了传统手工移动网站建设模式，可快速打开移动营销六大入口。</p>
<p>2、 web  Components : </p>
<p>组件化给前端开发带来了极大的效率提升，组件化的UI框架也因此层出不穷，从EXTJs、YUI到 jQuery UI ，再到 Bootstrap、React、Ratchet、Ionic等等等等等等，几乎每年都有很多新的UI框架冒出来，它们或者借鉴或者颠覆其他已存在的框架。简单对比一下就会发现这些框架的很大一部分模块在功能上是重合的，但也仅仅在功能层面重合，代码层面确完全不兼容。</p>
<p>Web Components 的出现给组件标准化带来了很好的契机：</p>
<p>WEB组件目前仍然依靠各种类似”Hack”的方式来模拟，模拟方式也各有不同，很难统一和标准化，而 Web Components 则直接提供了标准化的组件定义方式，这是组件标准化的基石，使得未来的组件能够统一创建、方法调用、事件监听、属性访问等。<br>基于标准化的组件定义方式，我们便可以像W3C等标准组织一样来定义组件标准，无需再依赖、等待“内置”组件，这也使得我们获得了“渔”的能力</p>
<h4 id="2、语音智能与H5的结合"><a href="#2、语音智能与H5的结合" class="headerlink" title="2、语音智能与H5的结合"></a>2、语音智能与H5的结合</h4><p>陈家军 科大讯飞  云平台事业部研发主管</p>
<h4 id="3、-浅析HTML5中的无障碍标签及用处"><a href="#3、-浅析HTML5中的无障碍标签及用处" class="headerlink" title="3、 浅析HTML5中的无障碍标签及用处"></a>3、 浅析HTML5中的无障碍标签及用处</h4><p>张昆 中国信息无障碍产品联盟  首席专家</p>
<h4 id="4、HTML5多屏互动平台实践"><a href="#4、HTML5多屏互动平台实践" class="headerlink" title="4、HTML5多屏互动平台实践"></a>4、HTML5多屏互动平台实践</h4><p>苏震巍 苏州盛派网络  CEO</p>
<h4 id="5、iWeb-议题：Weex-开发者工具探究"><a href="#5、iWeb-议题：Weex-开发者工具探究" class="headerlink" title="5、iWeb 议题：Weex 开发者工具探究"></a>5、iWeb 议题：Weex 开发者工具探究</h4><p>勾三股四（阿里巴巴 前端工程师）、梧叶（阿里巴巴 高级技术专家）</p>
<p>手淘和天猫曾经尝试过React Native，然后放弃了。但是把它的思想吸收过来，结合Web Component和Vue.js，然后就成了Weex.</p>
<h4 id="6、小米应用商店Hybrid性能优化实践"><a href="#6、小米应用商店Hybrid性能优化实践" class="headerlink" title="6、小米应用商店Hybrid性能优化实践"></a>6、小米应用商店Hybrid性能优化实践</h4><p>杨伟贤 小米  高级前端工程师</p>
<h4 id="7、Vue-js从入门到上线"><a href="#7、Vue-js从入门到上线" class="headerlink" title="7、Vue.js从入门到上线"></a>7、Vue.js从入门到上线</h4><p>陈陆扬 精雕细课  前端负责人</p>
<h2 id="四、游戏专场1-13：30-–-17：00"><a href="#四、游戏专场1-13：30-–-17：00" class="headerlink" title="四、游戏专场1 13：30 – 17：00"></a>四、游戏专场1 13：30 – 17：00</h2><h4 id="1、文学连接游戏-阅文集团“泛娱乐2-0”迎接H5领域新时代"><a href="#1、文学连接游戏-阅文集团“泛娱乐2-0”迎接H5领域新时代" class="headerlink" title="1、文学连接游戏 阅文集团“泛娱乐2.0”迎接H5领域新时代"></a>1、文学连接游戏 阅文集团“泛娱乐2.0”迎接H5领域新时代</h4><p>朱靖 阅文集团  副总裁</p>
<p>腾讯COO任宇昕与副总裁程武宣布正式成立阅文集团，统一管理和运营原本属于盛大文学和腾讯文学旗下的起点中文网、创世中文网、小说阅读网、潇湘书院、红袖添香、云起书院、榕树下、QQ阅读、中智博文、华文天下等网文品牌。</p>
<h4 id="2、Cocos-Creator：全面提升-H5-游戏的开发和运行速度"><a href="#2、Cocos-Creator：全面提升-H5-游戏的开发和运行速度" class="headerlink" title="2、Cocos Creator：全面提升 H5 游戏的开发和运行速度"></a>2、Cocos Creator：全面提升 H5 游戏的开发和运行速度</h4><p>王楠 触控科技  产品总监</p>
<p>Cocos Creator 是以内容创作为核心的游戏开发工具，在 Cocos2d-x 基础上实现了彻底脚本化、组件化和数据驱动等特点</p>
<h4 id="3、快创互娱，人人都是HTML5游戏创想家"><a href="#3、快创互娱，人人都是HTML5游戏创想家" class="headerlink" title="3、快创互娱，人人都是HTML5游戏创想家"></a>3、快创互娱，人人都是HTML5游戏创想家</h4><p>段会锋 快创互娱  合伙人兼技术副总</p>
<p>快创互娱是由大连文森软件特科技有限公司设计开发的一款HTML5在线开发平台。快创互娱是一款可视化、零代码、拖拽式编程的在线开发平台，基于HTML5及MIT开源协议，具有跨平台的强大性能。使用者可通过鼠标拖拽的简单方法，创造属于自己的故事、动画、游戏、课件，同时一键分享，轻松将作品上传至网络。</p>
<h4 id="4、Yahoo-Y5平台飛躍出海、強勢出航！"><a href="#4、Yahoo-Y5平台飛躍出海、強勢出航！" class="headerlink" title="4、Yahoo Y5平台飛躍出海、強勢出航！"></a>4、Yahoo Y5平台飛躍出海、強勢出航！</h4><p>赖俊光 Yahoo台湾与香港游戏频道   负责人</p>
<h4 id="5、发行和渠道为什么推那个产品"><a href="#5、发行和渠道为什么推那个产品" class="headerlink" title="5、发行和渠道为什么推那个产品"></a>5、发行和渠道为什么推那个产品</h4><p>李力维 独角兽游戏  CEO</p>
<h4 id="6、腾讯浏览服务，鼎力服务H5游戏生态"><a href="#6、腾讯浏览服务，鼎力服务H5游戏生态" class="headerlink" title="6、腾讯浏览服务，鼎力服务H5游戏生态"></a>6、腾讯浏览服务，鼎力服务H5游戏生态</h4><p>魏晓海 腾讯浏览器  内核开发总监技术专家</p>
<h4 id="7、H5游戏2-0时代到来"><a href="#7、H5游戏2-0时代到来" class="headerlink" title="7、H5游戏2.0时代到来"></a>7、H5游戏2.0时代到来</h4><p>姬海江 交叉点  CEO   一个外包公司</p>
<h2 id="五、游戏专场2-13：30-–-17：00"><a href="#五、游戏专场2-13：30-–-17：00" class="headerlink" title="五、游戏专场2 13：30 – 17：00"></a>五、游戏专场2 13：30 – 17：00</h2><h4 id="1、约三端，战未来"><a href="#1、约三端，战未来" class="headerlink" title="1、约三端，战未来"></a>1、约三端，战未来</h4><p>汪阔 Layabox  技术副总裁</p>
<h4 id="2、《小小战争》的设计经验分享"><a href="#2、《小小战争》的设计经验分享" class="headerlink" title="2、《小小战争》的设计经验分享"></a>2、《小小战争》的设计经验分享</h4><p>李瑞峰 圣堂科技  CEO     H5策略游戏</p>
<h4 id="3、H5游戏的未来发展"><a href="#3、H5游戏的未来发展" class="headerlink" title="3、H5游戏的未来发展"></a>3、H5游戏的未来发展</h4><p>赵鹏 横石科技  副总裁 在线网页游戏《弑沙》</p>
<h4 id="4、Lie-to-Me—聊聊HTML5多人实时在线游戏的优化"><a href="#4、Lie-to-Me—聊聊HTML5多人实时在线游戏的优化" class="headerlink" title="4、Lie to Me—聊聊HTML5多人实时在线游戏的优化"></a>4、Lie to Me—聊聊HTML5多人实时在线游戏的优化</h4><p>大城小胖  自由程序员 </p>
<p><a href="http://weibo.com/finscn?is_hot=1" target="_blank" rel="external">http://weibo.com/finscn?is_hot=1</a></p>
<p><a href="https://github.com/finscn" target="_blank" rel="external">https://github.com/finscn</a></p>
<h4 id="5、强化渠道产品联动，升级用户游戏体验"><a href="#5、强化渠道产品联动，升级用户游戏体验" class="headerlink" title="5、强化渠道产品联动，升级用户游戏体验"></a>5、强化渠道产品联动，升级用户游戏体验</h4><p>林玮 北京游琥科技  副总经理</p>
<h4 id="6、从市场角度分析H5游戏该如何立项"><a href="#6、从市场角度分析H5游戏该如何立项" class="headerlink" title="6、从市场角度分析H5游戏该如何立项"></a>6、从市场角度分析H5游戏该如何立项</h4><p>谭德文 上海越山科技  CEO</p>
<h4 id="7、H5游戏的困境和破局"><a href="#7、H5游戏的困境和破局" class="headerlink" title="7、H5游戏的困境和破局"></a>7、H5游戏的困境和破局</h4><p>黄加阳 9G游戏  CEO</p>
<h2 id="六、数字营销专场-13：30-–-17：00"><a href="#六、数字营销专场-13：30-–-17：00" class="headerlink" title="六、数字营销专场 13：30 – 17：00"></a>六、数字营销专场 13：30 – 17：00</h2><h4 id="1、后营销时代：借H5实现“移动互联网"><a href="#1、后营销时代：借H5实现“移动互联网" class="headerlink" title="1、后营销时代：借H5实现“移动互联网+"></a>1、后营销时代：借H5实现“移动互联网+</h4><p>张翔 白鹭时代、青雀移动  联合创始人、总经理</p>
<h4 id="2、-共享创赢移动网页大平台"><a href="#2、-共享创赢移动网页大平台" class="headerlink" title="2、    共享创赢移动网页大平台"></a>2、    共享创赢移动网页大平台</h4><p>马岳 Google  商业合作部行业总监</p>
<h4 id="3、-裂变·营销闭环·H5生态"><a href="#3、-裂变·营销闭环·H5生态" class="headerlink" title="3、    裂变·营销闭环·H5生态"></a>3、    裂变·营销闭环·H5生态</h4><p>刘旭 易企秀  联合创始人兼副总裁</p>
<p>易企秀是一款针对移动互联网营销的手机幻灯片、H5场景应用制作工具，将原来只能在PC端制作和展示的各类复杂营销方案转移到更为便携和展示的手机上，用户随时随地根据自己的需要在PC端、手机端进行制作和展示，随时随地营销。</p>
<h4 id="4、-喵葩：天猫电商互动技术新思路"><a href="#4、-喵葩：天猫电商互动技术新思路" class="headerlink" title="4、    喵葩：天猫电商互动技术新思路"></a>4、    喵葩：天猫电商互动技术新思路</h4><p>续彬 天猫  高级技术专家</p>
<h4 id="5、-网络营销未来的五大发展趋势"><a href="#5、-网络营销未来的五大发展趋势" class="headerlink" title="5、    网络营销未来的五大发展趋势"></a>5、    网络营销未来的五大发展趋势</h4><p>葛甲 北京蓝时代  互联网分析师，自媒体人</p>
<h4 id="6、-H5数字营销的技术痛点"><a href="#6、-H5数字营销的技术痛点" class="headerlink" title="6、    H5数字营销的技术痛点"></a>6、    H5数字营销的技术痛点</h4><p>余悠 跳跳糖创意  CEO</p>
<h4 id="7、-纽约广告节最佳数字营销作品赏析"><a href="#7、-纽约广告节最佳数字营销作品赏析" class="headerlink" title="7、    纽约广告节最佳数字营销作品赏析"></a>7、    纽约广告节最佳数字营销作品赏析</h4><p>吴金君<br>纽约广告节  中国首席代表</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-IOS 音频一览" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/15/IOS 音频一览/" class="article-date">
  	<time datetime="2015-03-15T04:34:11.000Z" itemprop="datePublished">Mar 15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/15/IOS 音频一览/">IOS 音频一览</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="IOS-音频一览"><a href="#IOS-音频一览" class="headerlink" title="IOS 音频一览"></a>IOS 音频一览</h4><blockquote>
<p>前言：<br>做嘉宾聊天室这个需求的时候接触了音频和视频上的开发，嘉宾可以发布视频和语音以及文字信息出来，观众则可以文字回复，这样主持人嘉宾和观众就形成一个良性的互动过程。在这里把相关整理一下，望给大家带来一些认识。</p>
</blockquote>
<h1 id="一、了解音频"><a href="#一、了解音频" class="headerlink" title="一、了解音频"></a>一、了解音频</h1><p>声音作为信息的一种媒介载体必不可少，在移动端体现为各类语音交流以及音乐等，开发中使用的音频文件通过声音采样、量化、编码几步从而成为人耳可听的声音，频率为20HZ到20KHZ，奈奎斯特的理论表明采样率高于最高频2倍时候，是可以将数字信号还原为原来的模拟信号的，所以通常我们在网上看到的音频文件的采样率为44.1KHZ。</p>
<p>采样后通过量化的脉冲编码调制，我们得到了PCM类型的数据，比如在使用AVAudioRecorder采样的时候可以看到采样类型kAudioFormatLinearPCM。但是这样拿到的数据是很大的，不便于使用和传输，通过对人类不敏感的声音区域进行过滤压缩，就有了MP3、AAC、OGG、WMA等数据格式类型，这些都是有损压缩。</p>
<p>码率代码了压缩质量，比如MP3常用码率有128kbit/s、160kbit/s、320kbit/s等等，越高代表着声音音质越好。MP3中的数据有ID3和音频数据组成，ID3用于存储歌名、演唱者、专辑、音轨等我们可以常见的信息。</p>
<h1 id="二、IOS对音频的操作"><a href="#二、IOS对音频的操作" class="headerlink" title="二、IOS对音频的操作"></a>二、IOS对音频的操作</h1><p>开发实际上是为了解决需求，需求对应的是使用场景，开发的方式很多，不同的使用场景可以使用的方法不同。IOS开发提供了以下几种常用方式供我们解决对应的音频需求。</p>
<ul>
<li>System Sound Services </li>
<li>AVFoundation 框架</li>
<li>Media Player 框架</li>
</ul>
<h2 id="2-1-System-Sound-Services"><a href="#2-1-System-Sound-Services" class="headerlink" title="2.1  System Sound Services"></a>2.1  System Sound Services</h2><h4 id="2-1-1-场景特点"><a href="#2-1-1-场景特点" class="headerlink" title="2.1.1 场景特点"></a>2.1.1 场景特点</h4><p>最底层也是简单的声音播放服务，此方法是适合播放提示警告类型的短小的声音</p>
<h4 id="2-1-2-存在限制"><a href="#2-1-2-存在限制" class="headerlink" title="2.1.2 存在限制"></a>2.1.2 存在限制</h4><ul>
<li>声音长度要小于 30 秒</li>
<li>In linear PCM 或者 IMA4 (IMA/ADPCM) 格式的</li>
<li>打包成 .caf, .aif, 或者 .wav 的文件</li>
<li>不能控制播放的进度</li>
<li>调用方法后立即播放声音</li>
<li>没有循环播放和立体声控制：</li>
</ul>
<h4 id="2-1-3-使用方式"><a href="#2-1-3-使用方式" class="headerlink" title="2.1.3 使用方式"></a>2.1.3 使用方式</h4><p>调用 AudioServicesCreateSystemSoundID(CFURLRef inFileURL,SystemSoundID *outSystemSoundID) 该函数的第一个参数代表音频文件的URL（可通过NSURL转换成CFURLRef），第二个参数代表注册音频文件的SystemSoundID。</p>
<p>调用AudioServicesAddSystemSoundCompletion()函数为制定SystemSoundID注册Callback函数。有了 CallBack 函数我们可以解决不少问题，比如可以克服 System Sound Services 本身不支持循环播放的问题。</p>
<p>调用AudioServicePlaySystemSound函数或者AudioServicePlayAlertSound（调用系统振动功能）。</p>
<pre><code>- (void)viewDidLoad
{
[super viewDidLoad];

// 1. 定义要播放的音频文件的URL
NSURL *voiceURL = [[NSBundle mainBundle]URLForResource:@&quot;CleanDidFinish&quot; withExtension:@&quot;aiff&quot;];

// 2. 注册音频文件（第一个参数是音频文件的URL 第二个参数是音频文件的SystemSoundID）
AudioServicesCreateSystemSoundID((__bridge CFURLRef)(voiceURL),&amp;ditaVoice);

// 3. 为crash播放完成绑定回调函数AudioServicesAddSystemSoundCompletion(ditaVoice,NULL,NULL,(void*)completionCallback,NULL);

// 4. 播放 ditaVoice 注册的音频 并控制手机震动
AudioServicesPlayAlertSound(ditaVoice);

//    AudioServicesPlaySystemSound(ditaVoice);
//    AudioServicesPlaySystemSound(kSystemSoundID_Vibrate); // 控制手机振动

}
</code></pre><h2 id="2-2-AVFoundation-框架"><a href="#2-2-AVFoundation-框架" class="headerlink" title="2.2  AVFoundation 框架"></a>2.2  AVFoundation 框架</h2><h4 id="2-2-1-场景特点"><a href="#2-2-1-场景特点" class="headerlink" title="2.2.1 场景特点"></a>2.2.1 场景特点</h4><p>如果播放较大的音频或者要对音频有精确的控制，则System Sound Service可能就很难满足实际需求了，通常这种情况会选择使用AVFoundation，它可以满足我们通常意义上的绝大部分的场景需求，包括音乐的交互、声音的制作等等，根据自己的业务需求实现自定义的定制化。如果你只是想实现音频的播放或者录制，没有其他需求，AVFoundation会很好的满足你，它的接口使用简单、不用关心其中的细节。</p>
<h4 id="2-2-2-关键点和API浏览"><a href="#2-2-2-关键点和API浏览" class="headerlink" title="2.2.2 关键点和API浏览"></a>2.2.2 关键点和API浏览</h4><blockquote>
<p>Background Modes</p>
</blockquote>
<p>打开后台模式的音乐播放，或者在info.plist文件中添加Required Background Modes键，其值是App plays audio or streams audio/video using AirPlay</p>
<blockquote>
<p>AVAudioSession</p>
</blockquote>
<p>用于 iOS 系统中协调应用程序之间的音频播放的 API 的。例如，当有电话打进来时，音频的播放就会被暂停；在用户启动电影时，音乐的播放就会停止。我们需要使用这些 API 来确保一个应用程序能够正确响应并处理这类事件。</p>
<blockquote>
<p>AVAudioPlayer</p>
</blockquote>
<p>这个高层级的 API 为你提供一个简单的接口，用来播放本地或者内存中的音频。这是一个无界面的音频播放器 (也就是说没有提供 UI 元素)，使用起来也很直接简单。它不适用于网络音频流或者低延迟的实时音频播放。如果这些问题都不需要担心，那么 AVAudioPlayer 可能就是正确的选择。音频播放器的 API 也为我们带来了一些额外的功能，比如循环播放、获取音频的音量强度等等。</p>
<blockquote>
<p>AVAudioRecorder</p>
</blockquote>
<p>作为与 AVAudioPlayer 相对应的 API，AVAudioRecorder 是将音频录制为文件的最简单的方法。除了用一个音量计接受音量的峰值和平均值以外，这个 API 简单粗暴，但要是你的使用场景很简单的话，这可能恰恰就是你想要的方法。</p>
<blockquote>
<p>AVPlayer</p>
</blockquote>
<p>AVPlayer 与上面提到的 API 相比，提供了更多的灵活性和可控性。它基于 AVPlayerItem 和 AVAsset，为你提供了颗粒度更细的权限来获取资源，比如选择指定的音轨。它还通过 AVQueuePlayer 子类支持播放列表，而且你可以控制这些资源是否能够通过 AirPlay 发送。</p>
<h4 id="与-AVAudioPlayer-最主要的区别是，AVPlayer-对来自网络的流媒体资源的-“开箱即用”-支持。这增加了处理播放状态的复杂性，但是你可以使用-KVO-来观测所有的状态参数来解决这个问题。"><a href="#与-AVAudioPlayer-最主要的区别是，AVPlayer-对来自网络的流媒体资源的-“开箱即用”-支持。这增加了处理播放状态的复杂性，但是你可以使用-KVO-来观测所有的状态参数来解决这个问题。" class="headerlink" title="与 AVAudioPlayer 最主要的区别是，AVPlayer 对来自网络的流媒体资源的 “开箱即用” 支持。这增加了处理播放状态的复杂性，但是你可以使用 KVO 来观测所有的状态参数来解决这个问题。"></a>与 AVAudioPlayer 最主要的区别是，AVPlayer 对来自网络的流媒体资源的 “开箱即用” 支持。这增加了处理播放状态的复杂性，但是你可以使用 KVO 来观测所有的状态参数来解决这个问题。</h4><blockquote>
<p> AVAudioEngine</p>
</blockquote>
<p>AVAudioEngine 是播放和录制的 Objective-C 接口。它提供了以前需要深入到 Audio Toolbox 框架的 C API 才能做的控制 (例如一些实时音频任务)。该音频引擎 API 对底层的 API 建立了优秀的接口。如果你不得不处理底层的问题，你仍然可以使用 Audio Toolbox 框架。</p>
<p>这个 API 的基本概念是建立一个音频的节点图，从源节点 (播放器和麦克风) 以及过处理 (overprocessing) 节点 (混音器和效果器) 到目标节点 (硬件输出)。每一个节点都具有一定数量的输入和输出总线，同时这些总线也有良好定义的数据格式。这种结构使得它非常的灵活和强大。而且它集成了音频单元 (audio unit)。</p>
<h2 id="2-3-Media-Player-框架"><a href="#2-3-Media-Player-框架" class="headerlink" title="2.3 Media Player 框架"></a>2.3 Media Player 框架</h2><h4 id="2-3-1-场景特点"><a href="#2-3-1-场景特点" class="headerlink" title="2.3.1 场景特点"></a>2.3.1 场景特点</h4><p>众所周知音乐是iOS的重要组成播放，无论是iPod、iTouch、iPhone还是iPad都可以在iTunes购买音乐或添加本地音乐到音乐库中同步到你的iOS设备。在MediaPlayer.frameowork中有一个MPMusicPlayerController用于播放音乐库中的音乐。Media Player 框架是 iOS 平台上一个用于音频和视频播放的高层级接口，它包含了一个你可以在应用中直接使用的默认的用户界面。你可以使用它来播放用户在 iPod 库中的项目，或者播放本地文件以及网络流。这个框架也包括了查找用户媒体库中内容的 API，同时还可以配置像是在锁屏界面或者控制中心里的音频控件。</p>
<h4 id="2-3-2-使用方式"><a href="#2-3-2-使用方式" class="headerlink" title="2.3.2 使用方式"></a>2.3.2 使用方式</h4><p>使用MPMusicPlayerController实例化对象来播放内置音乐库的媒体文件，有以下两种类方法来实例化对象：</p>
<p>MPMusicPlayerController *playController = [MPMusicPlayerController systemMusicPlayer]; </p>
<p>说明：播放内置媒体库项目取代用户目前播放状态（如果是用网易云音乐或QQQ音乐在播放歌曲）</p>
<p>MPMusicPlayerController *playController = [MPMusicPlayerController applicationMusicPlayer]; </p>
<p>说明：播放该应用内的歌曲，不影响本机自带音乐播放器的状态。</p>
<ul>
<li><p>判断有没有正在播放的媒体</p>
<pre><code>[MPMusicPlayerController indexOfNowPlayingItem] == NSNotFound
</code></pre></li>
<li><p>创建媒体队列</p>
<pre><code>[MPMediaQuery songsQuery];
[MPMusicPlayerController setQueueWithQuery:nil];
</code></pre></li>
<li><p>获取媒体曲目的信息</p>
</li>
</ul>
<pre><code>MPMediaItem *currentItem = ....
NSString *artist = [currentItem valueForProperty:MPMediaItemPropertyArtist];
NSString *songName = [currentItem valueForProperty:MPMediaItemPropertyTitle];
</code></pre><ul>
<li><p>监听媒体通知</p>
<pre><code>NSNotificationCenter *notificationCenter = [NSNotificationCenter defaultCenter];[notificationCenter addObserver:self
              selector:@selector()
                       name:MPMusicPlayerControllerNowPlayingItemDidChangeNotification
                     object:nil];
</code></pre></li>
</ul>
<h2 id="2-4-更多音频方案"><a href="#2-4-更多音频方案" class="headerlink" title="2.4 更多音频方案"></a>2.4 更多音频方案</h2><p>CoreAudio的接口层次：</p>
<p><img src="/assets/images/api.png" alt=""></p>
<h4 id="2-4-1-OpenAL"><a href="#2-4-1-OpenAL" class="headerlink" title="2.4.1 OpenAL"></a>2.4.1 OpenAL</h4><p>OpenAL 是一个跨平台的 API。它提供了位置 (3D) 和低延迟的音频服务。它主要用于跨平台游戏的开发。它有意地模仿了 OpenGL 中 API 的风格。</p>
<h4 id="2-4-2-Audio-Unit-框架"><a href="#2-4-2-Audio-Unit-框架" class="headerlink" title="2.4.2  Audio Unit 框架"></a>2.4.2  Audio Unit 框架</h4><p>Audio Unit 框架是一个底层的 API；所有 iOS 中的音频技术都构建在 Audio Unit 这个框架之上。音频单元是用来加工音频数据的插件。一个音频单元链叫做音频处理图。</p>
<p>如果你需要非常低的延迟 (如 VoIP 或合成乐器)、回声消除、混音或者音调均衡的话，你可能需要直接使用音频单元，或者自己写一个音频单元。但是其中的大部分工作可以使用 AVAudioEngine 的 API 来完成。如果你不得不写自己的音频单元的话，你可以将它们与 AVAudioUnit 节点一起集成在 AVAudioEngine 处理图中。</p>
<h4 id="2-4-2-AudioToolBox-框架"><a href="#2-4-2-AudioToolBox-框架" class="headerlink" title="2.4.2 AudioToolBox 框架"></a>2.4.2 AudioToolBox 框架</h4><p>通过AudioToolbox框架，可以将短声音注册到system sound服务上，被注册到system sound服务上的声音称之为 system sounds。<br>前面常用的System Sound Services 就来自这里的框架。</p>
<p>它必须满足下面几个条件：</p>
<p>(1).播放的时间不能超过30秒</p>
<p>(2).数据必须是 PCM或者IMA4流格式</p>
<p>(3).必须被打包成下面三个格式之一：Core Audio Format (.caf), Waveform audio (.wav), 或者 Audio Interchange File (.aiff)</p>
<p>(4）声音文件必须放到设备的本地文件夹下面。通过AudioServicesCreateSystemSoundID方法注册这个声音文件.</p>
<h4 id="2-4-3-CoreMIDI-和-CoreAudioKit-框架"><a href="#2-4-3-CoreMIDI-和-CoreAudioKit-框架" class="headerlink" title="2.4.3 CoreMIDI 和 CoreAudioKit 框架"></a>2.4.3 CoreMIDI 和 CoreAudioKit 框架</h4><p>在 iOS 上，Core MIDI 和 CoreAudioKit 可以被用来使应用程序表现为 MIDI 设备。在 OS X 上，Music Sequencing 服务提供了基于 MIDI 的控制和对音乐数据访问的权限。Core MIDI 服务为服务器和驱动程序提供了支持。</p>
<h4 id="2-4-4-QTKit-和-QuickTime-框架"><a href="#2-4-4-QTKit-和-QuickTime-框架" class="headerlink" title="2.4.4 QTKit 和 QuickTime 框架"></a>2.4.4 QTKit 和 QuickTime 框架</h4><p>现在已经过时了，它们不应该被用在以后的开发中。我们应该使用 AVFoundation (和 AVKit) 来代替它们</p>
<h1 id="三、今日头条嘉宾聊天室音频实践"><a href="#三、今日头条嘉宾聊天室音频实践" class="headerlink" title="三、今日头条嘉宾聊天室音频实践"></a>三、今日头条嘉宾聊天室音频实践</h1><h2 id="3-1-背景"><a href="#3-1-背景" class="headerlink" title="3.1 背景"></a>3.1 背景</h2><p>嘉宾聊天室是头条16年初新起的一个项目服务，目标是为了引进明星嘉宾访谈类型和体育赛事线上直播的节目，丰富头条在直播领域的内容，聊天室一期是属于图文、语音、短视频直播，后期发展可成为视频线上直播。表现形式与网易直播频道类似，但更丰富。</p>
<h2 id="3-2-IOS端实现"><a href="#3-2-IOS端实现" class="headerlink" title="3.2 IOS端实现"></a>3.2 IOS端实现</h2><p>根据聊天室在语音和视频的需求，使用系统自带实现的MPMoviePlayerController没法符合自定义的需求，包括功能与交互设计，并且MPMoviePlayerController已经不被苹果官方提倡，将要通过AVPlayer方案代替。需求本身的属于基本的语音和视频沟通，只对音频视频的录制与播放，符合音质画质要求和大小要求，因此采用AVFoundation框架即可，能够满足聊天室的需求。主要使用了AVPlayer、AVAudioRecorder、AVAudioSession等主要的类。</p>
<p>实现类有如下等：</p>
<pre><code>#import &quot;TTAudioRecorder.h&quot;
#import &quot;TTAudioPlayer.h&quot;
#import &quot;TTLiveCameraViewController.h&quot;
#import &quot;TTUploadVideoAudioManager.h&quot;
#import &quot;TTLiveAudioManager.h&quot;
</code></pre><h2 id="3-3-问题与解决"><a href="#3-3-问题与解决" class="headerlink" title="3.3 问题与解决"></a>3.3 问题与解决</h2><p>整个需求的实现过程还算顺利，按照API说明理解即可，提两三点说明下都会遇见哪一类的问题。</p>
<h4 id="3-1-音频格式为AMR"><a href="#3-1-音频格式为AMR" class="headerlink" title="3.1 音频格式为AMR"></a>3.1 音频格式为AMR</h4><p>AVPlayer来播放视频音频都相当强大，但是它也存在着一些不可回避的问题，那就是目前IOS已经不再支持AMR格式的播放。</p>
<pre><code>AMR format is no longer supported by Apple (since iOS 4.3)
</code></pre><p>与安卓同步开发的时候对接确立的通用的格式为AMR，因为AAC文件在网络传输下载播放的时候显得很大，AMR相对来说会好很多，同时我们也看了微博和微信的实现都是使用AMR，鉴于头条的用户量和使用体验，于是就采用了同样的方式。安卓可以很好支持AMR，在iOS平台上需要进行WAV和AMR之间的转换，好在libopencore可以解决这个事。网络上有好些所谓的相互转化的库，仔细看了下，都没有脱离这个core本身。</p>
<p>libopencore库：</p>
<pre><code>interf_dec.h 
interf_enc.h
dec_if.h
if_rom.h
libopencore-amrnb.a
libopencore-amrwb.a
</code></pre><p>主要方法：</p>
<pre><code>EncodeWAVEFileToAMRFile 、 DecodeAMRFileToWAVEFile
</code></pre><p>封装一个mannager：        </p>
<pre><code>#import &lt;Foundation/Foundation.h&gt;

@interface VoiceConverter : NSObject

+ (int)amrToWav:(NSString*)_amrPath wavSavePath:(NSString*)_savePath;

+ (int)wavToAmr:(NSString*)_wavPath amrSavePath:(NSString*)_savePath;

@end
</code></pre><h4 id="3-2-WAV转化AMR声音变形："><a href="#3-2-WAV转化AMR声音变形：" class="headerlink" title="3.2 WAV转化AMR声音变形："></a>3.2 WAV转化AMR声音变形：</h4><p>录制WAV格式本地正常播放，转化为AMR后，把AMR格式文件在电脑端播放，声音严重变形，无法识别，再转化会WAV,，手机还是无法识别。<br>原因与解决<br>声音格式转化采用的是”amrFileCodec.h”，它对转化的音频输入源是有格式要求的，要求转化的采样率为标准的8k，如果录制的音频频率采用高频率44.1K的话就会出现变形，我想这里的设定依据来自于amr格式的采样率通常为8K。通过AVAudioRecorder把采样率设置为8K后，可以正常互相转化。</p>
<blockquote>
<p>AMR维基百科：</p>
<p>采样率 8 kHz/13-bit (160 采样点每20ms)，滤波后只保留 200-3400 Hz 范围内的信号.</p>
<p>编码器使用8个位速：12.2、10.2、7.95、7.40、6.70、5.90、5.15和4.75 kbit/s.</p>
</blockquote>
<pre><code>NSMutableDictionary *settings=[NSMutableDictionary dictionary];
[settings setObject:@(kAudioFormatLinearPCM) forKey:AVFormatIDKey];
[settings setObject:@(8000) forKey:AVSampleRateKey]; //必须和amr文件解码参数保持一致
[settings setObject:@(1) forKey:AVNumberOfChannelsKey];
[settings setObject:@(16) forKey:AVLinearPCMBitDepthKey];
[settings setObject:@(NO) forKey:AVLinearPCMIsFloatKey];
[settings setValue:@(NO) forKey:AVLinearPCMIsNonInterleaved];
[settings setValue:@(NO) forKey:AVLinearPCMIsBigEndianKey];
[settings setValue:@(AVAudioQualityHigh) forKey:AVEncoderAudioQualityKey];
AVAudioRecorder *recorderTemp = [[AVAudioRecorder alloc] initWithURL:fileUrl settings:settings error:nil];
</code></pre><h4 id="3-3-AVPlayer的准备状态"><a href="#3-3-AVPlayer的准备状态" class="headerlink" title="3.3 AVPlayer的准备状态"></a>3.3 AVPlayer的准备状态</h4><p>当AVPlayer的status变为AVPlayerStatusReadyToPlay后，依旧可能无法开始播放？</p>
<p>AVPlayerStatusReadyToPlay属性只是表明了AVPlayer已经成功的载入了AVPlayerItem，并且准备好，但是实际的是否能播放时由AVPlayerItem的status到达AVPlayerItemStatusReadyToPlay的时候，才能开始正常播放的。<br>如果我们的App使用CPU过多，I/O读写过多时，有可能导致直接无法播放，我们再调用play或者seekToTime:方法都无法正常播放，尤其是视频。所以我们需要做一个真正播放状态准备好的判断，也可以通过KVO去监听AVPlayerItem的status。</p>
<pre><code>//播放器是否准备好
if (self.videoPrePlayer.status == AVPlayerStatusReadyToPlay) 
{
    //视频是否加载成功
    if(self.videoPrePlayer.currentItem.status == AVPlayerItemStatusFailed){   
        return;
    }
        [self.videoPrePlayer play];

}
</code></pre><h1 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h1><p>文章主要对音频的使用范畴做了概括，并列举了两三实践点，其他的并没有做详细的论述，因为本篇比较偏向音频知识的介绍，知道用什么工具框架后再具体解决就好。比如如何播放流畅的网络音频，如何实现音频的快放与慢放等具体问题，此次需求内容并不复杂没有涉及，他们都可以通过 AudioToolBox框架实现。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-IOS视频录制--AVFoudation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/28/IOS视频录制--AVFoudation/" class="article-date">
  	<time datetime="2015-01-28T11:09:59.000Z" itemprop="datePublished">Jan 28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/28/IOS视频录制--AVFoudation/">IOS视频录制</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="IOS-视频录制-—-AVFoundation"><a href="#IOS-视频录制-—-AVFoundation" class="headerlink" title="IOS 视频录制 — AVFoundation"></a>IOS 视频录制 — AVFoundation</h1><p>AVFoundation是为数不多的几个框架,您可以使用和创建基于时间的视听媒体。它提供了一个objective - c接口用于工作与基于时间的视听数据详细的级别。例如,您可以使用它来检查,创建、编辑或reencode媒体文件。你也可以输入流从设备和操作视频实时捕捉和回放。</p>
<h2 id="一、概念引导："><a href="#一、概念引导：" class="headerlink" title="一、概念引导："></a>一、概念引导：</h2><h3 id="1、ASSets媒体文件"><a href="#1、ASSets媒体文件" class="headerlink" title="1、ASSets媒体文件:"></a>1、ASSets媒体文件:</h3><p>1）AVAsset</p>
<p>一个抽象类来表示时间等视听媒体视频和声音。每个资产包含一组跟踪旨在呈现或加工在一起,一个统一的媒体类型,包括但不限于音频、视频、文本、关闭字幕,字幕。</p>
<p>AVURLAsset *anAsset = [[AVURLAsset alloc] initWithURL:url options:nil];属性有<br>tracks、duration、preferredVolume、preferredTransform等等。</p>
<p>2) 一个AVAssetTrack</p>
<p>对象提供了所有资产提供track-level检查接口,方便对ASSets进行更具体的属性获取以及对应的操作。</p>
<p>3）AVAssetImageGenerator</p>
<p>对象提供缩略图或预览图像的资产独立于回放，可以生成单独的图片，也可以生成图片队列，这是获取视频缩略图的方式之一，还有另外两种ALAsset的thumbnail 和 - (UIImage *)imageFromSampleBuffer:(CMSampleBufferRef)sampleBuffer。</p>
<p>4）AVAssetExportSession</p>
<p>针对AVAsset源对象的内容进行转码，创建一个被指定输出形式的资源。</p>
<p><img src="/assets/images/AVAssetExportSession.jpg" alt=""></p>
<h3 id="2、Playback播放控制"><a href="#2、Playback播放控制" class="headerlink" title="2、Playback播放控制:"></a>2、Playback播放控制:</h3><p>1) AVPlayer</p>
<p>你使用一个AVPlayer对象来实现控制器和用户接口单一或多种条目回放。</p>
<ul>
<li><p>-  (instancetype)initWithPlayerItem:(AVPlayerItem *)item</p>
</li>
<li><p>play 、 parse 、 end</p>
</li>
<li><p>- (void)seekToTime:(CMTime)time</p>
</li>
</ul>
<p>2) AVPlayerLayer</p>
<p>用于显示视频内容，相当于大屏幕。里面有videoGravity，默认值 AVLayerVideoGravityResizeAspect.</p>
<p>3) AVPlayerItem</p>
<p>一个AVPlayerItem代表资产的表现状态,由一个AVPlayer对象和可以观察到的状态。对视频播放状态修改一起监听的过程多数发生在正对这个对象的操作操作上，比如：</p>
<ul>
<li>seekToTime，从哪里开始播放</li>
<li>各种资源播放状态的通知AVPlayerItemFailedToPlayToEndTimeNotification<br>等</li>
</ul>
<p>4) AVPlayerItemTrack </p>
<p>你用一个AVPlayerItemTrack对象修改资产的表现状态跟踪(AVAssetTrack)一个AVPlayer对象。通常视频的加载播放有各种状态，我们需要KVO监听或者添加通知去知道播放器的准备、进行、暂停、停止等状态。</p>
<p>5) AVQueuePlayer</p>
<p>按照队列播放视频</p>
<ul>
<li><p>queuePlayerWithItems，</p>
</li>
<li><p>insertItem:(AVPlayerItem *)item</p>
<pre><code>afterItem:(AVPlayerItem *)afterItem
</code></pre></li>
</ul>
<h3 id="3、Editing资源编辑"><a href="#3、Editing资源编辑" class="headerlink" title="3、Editing资源编辑:"></a>3、Editing资源编辑:</h3><p>AVFoundation框架提供了一个功能丰富的组类促进视听资产的编辑。AVFoundation的编辑API的核心成分，就是一组追踪从一个或多个不同的媒体资产。AVMutableComposition类提供了一个接口,用于插入和删除操作的痕迹,以及管理自己时间排序。</p>
<p><img src="/assets/images/AVMutableComposition.jpg" alt=""></p>
<p>1）AVMutableComposition</p>
<p>是一个可变的AVComposition子类，当您想要从现有资产创建一个新的资源。你可以添加和删除跟踪,可以添加、删除和时间范围。<br>比如：</p>
<ul>
<li>– insertEmptyTimeRange：可以增加一段空白时间</li>
</ul>
<ul>
<li>– insertTimeRange:ofAsset:atTime:error:<br>插入的所有跟踪给定的时间范围内指定的资产到接收机。</li>
</ul>
<!-- -->
<pre><code>AVAsset *videoAsset = &lt;#AVAsset with at least one video track#&gt;;
AVAsset *anotherVideoAsset = &lt;#another AVAsset with at least one video track#&gt;;
// Get the first video track from each asset.
AVAssetTrack *videoAssetTrack = [[videoAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
AVAssetTrack *anotherVideoAssetTrack = [[anotherVideoAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
// Add them both to the composition.
[mutableCompositionVideoTrack insertTimeRange:CMTimeRangeMake(kCMTimeZero,videoAssetTrack.timeRange.duration) ofTrack:videoAssetTrack atTime:kCMTimeZero error:nil];
[mutableCompositionVideoTrack insertTimeRange:CMTimeRangeMake(kCMTimeZero,anotherVideoAssetTrack.timeRange.duration) ofTrack:anotherVideoAssetTrack atTime:videoAssetTrack.timeRange.duration error:nil];&apos;
</code></pre><p>2) AVMutableAudioMix </p>
<p>一个AVMutableAudioMix对象管理混合音轨的输入参数。它允许自定义音频处理在回放期间音轨或执行其他操作。</p>
<!--0-->
<pre><code>AVMutableAudioMix *mutableAudioMix = [AVMutableAudioMix audioMix];
// Create the audio mix input parameters object.
AVMutableAudioMixInputParameters *mixParameters = [AVMutableAudioMixInputParameters audioMixInputParametersWithTrack:mutableCompositionAudioTrack];
// Set the volume ramp to slowly fade the audio out over the duration of the composition.
[mixParameters setVolumeRampFromStartVolume:1.f toEndVolume:0.f timeRange:CMTimeRangeMake(kCMTimeZero, mutableComposition.duration)];
// Attach the input parameters to the audio mix.
mutableAudioMix.inputParameters = @[mixParameters];
</code></pre><h3 id="4、Media-Capture媒体捕捉"><a href="#4、Media-Capture媒体捕捉" class="headerlink" title="4、Media Capture媒体捕捉:"></a>4、Media Capture媒体捕捉:</h3><p>1) AVCaptureDevice </p>
<p>代表输入设备,如摄像头或麦克风</p>
<p>2) AVCaptureInput </p>
<p>输入设备的配置端口，我们可以理解为输入</p>
<p>3）AVCaptureSession</p>
<p>协调数据流从输入到输出,用startRunning开始从输入到输出的数据流,并调用stopRunning停止流动。采取关闭代理，保证取景器一直流动。</p>
<p>4) AVCaptureOutput </p>
<ul>
<li><p>AVCaptureMovieFileOutput，输入到视频文件，代理AVCaptureFileOutputRecordingDelegate</p>
</li>
<li><p>AVCaptureVideoDataOutput，如果想要实时的处理每一帧数据，或想要有自己的图形动画，代理AVCaptureVideoDataOutputSampleBufferDelegate</p>
</li>
</ul>
<ul>
<li><p>AVCaptureAudioDataOutput ，音频数据，代理AVCaptureVideoDataOutputSampleBufferDelegate</p>
</li>
<li><p>AVCaptureStillImageOutput ，图片数据</p>
</li>
</ul>
<p>5）AVCaptureVideoPreviewLayer </p>
<p>实时展示被session传出出来的视频流数据，也就是我们的取景器</p>
<p>6）AVCaptureConnection </p>
<p>代表捕获之间的连接输入和输出对象关联到一个捕获会话。</p>
<p><img src="/assets/images/AVCaptureConnection.jpg" alt=""></p>
<h3 id="5、Export媒体输出"><a href="#5、Export媒体输出" class="headerlink" title="5、Export媒体输出:"></a>5、Export媒体输出:</h3><p>1) AVAssetExportSession</p>
<p>针对AVAsset对象转码，创建一个输出的形式被指定出口预设内容。包括对输出媒体资源的属性设定，可以设置presetName进行视频品质压缩，AVAssetExportPresetLowQuality等。也可以设置属性包括：outputFileType<br>、fileLengthLimit、timeRange<br>等。</p>
<p>2）AVAssetReader </p>
<p>直接从媒体读取存储样本,获得样本解码成可渲染的形式。组合资产多个音轨和组合多个视频跟踪(通过使用AVAssetReaderAudioMixOutput和AVAssetReaderVideoCompositionOutput)。</p>
<ul>
<li>addOutPut</li>
<li>startReading</li>
<li>cancelReading</li>
</ul>
<p>读取一个音频：</p>
<!--0-->
<pre><code>AVAudioMix *audioMix = &lt;#An AVAudioMix that specifies how the audio tracks from the AVAsset are mixed#&gt;;
// Assumes that assetReader was initialized with an AVComposition object.
AVComposition *composition = (AVComposition *)assetReader.asset;
// Get the audio tracks to read.
NSArray *audioTracks = [composition tracksWithMediaType:AVMediaTypeAudio];
// Get the decompression settings for Linear PCM.
NSDictionary *decompressionAudioSettings = @{ AVFormatIDKey : [NSNumber numberWithUnsignedInt:kAudioFormatLinearPCM] };
// Create the audio mix output with the audio tracks and decompression setttings.
AVAssetReaderOutput *audioMixOutput = [AVAssetReaderAudioMixOutput assetReaderAudioMixOutputWithAudioTracks:audioTracks audioSettings:decompressionAudioSettings];
// Associate the audio mix used to mix the audio tracks being read with the output.
audioMixOutput.audioMix = audioMix;
// Add the output to the reader if possible.
if ([assetReader canAddOutput:audioMixOutput])
[assetReader addOutput:audioMixOutput];
</code></pre><p>3) AVAssetWriter</p>
<p>使用一个AVAssetWriter对象媒体数据写入新文件指定视听的容器类型,如QuickTime电影文件或一个mp4文件,支持自动交叉媒体数据的多个并发的痕迹。</p>
<ul>
<li>initWithURL:fileType:error:</li>
<li>startWriting</li>
<li>startSessionAtSourceTime</li>
<li>addInput</li>
<li>endSessionAtSourceTime</li>
<li>finishWritingWithCompletionHandler</li>
</ul>
<h2 id="二、代码实践："><a href="#二、代码实践：" class="headerlink" title="二、代码实践："></a>二、代码实践：</h2><blockquote>
<h3 id="import-“TTCameraViewController-h”"><a href="#import-“TTCameraViewController-h”" class="headerlink" title="#import “TTCameraViewController.h”"></a>#import “TTCameraViewController.h”</h3></blockquote>
<h2 id="三、问题回顾："><a href="#三、问题回顾：" class="headerlink" title="三、问题回顾："></a>三、问题回顾：</h2><h3 id="1、视频文件写入崩溃："><a href="#1、视频文件写入崩溃：" class="headerlink" title="1、视频文件写入崩溃："></a>1、视频文件写入崩溃：</h3><h4 id="现象："><a href="#现象：" class="headerlink" title="现象："></a>现象：</h4><p>相机开始拍摄就会出现崩溃，时而出现，有时难以复现。</p>
<h4 id="原因与解决："><a href="#原因与解决：" class="headerlink" title="原因与解决："></a>原因与解决：</h4><p>1）startSessionAtSourceTime只能在 AVAssetWriterStatusWriting的之后调用，但是startWriting调用之后writer并没有立即变为writing状态，而已有一个极短的开始时间，参照苹果规范使用文档，只需要前面调用之后后面就可以跟着执行startSessionAtSourceTime，然而，我遇见了这问题，说明它并不是。随后我到stackoverflow上查了问题，发现有人早就提过，并没有答案，说是升级IOS8以后就没有了，可我这里是IOS9…随后我只能判断writer状态如果是writing就开始执行，如果不是就调用startWriting。</p>
<p>2）[videoWriterInput appendSampleBuffer：xxx]这只能在startSessionAtSourceTime开始之后调用，和1是同样的情况，明明第一行调用了startSessionAtSourceTime，第二调用appendSampleBuffer就会崩溃，并且依旧是偶尔发生。但是这里的问题是没有一个状态可以判断是否已经开始startSessionAtSourceTime，这里就有点血崩了，不能像问题1一样判断解决，后来只好try catch了,稳住局面防止崩溃，丢失极少的毫秒级帧数。</p>
<h3 id="2、相机拍摄闪烁抖动："><a href="#2、相机拍摄闪烁抖动：" class="headerlink" title="2、相机拍摄闪烁抖动："></a>2、相机拍摄闪烁抖动：</h3><h4 id="现象：-1"><a href="#现象：-1" class="headerlink" title="现象："></a>现象：</h4><p>开始拍摄时候，取景器闪烁抖动，引起一小部分可见范围内的视频内容发送抖动，并被存入文件中，体验差。</p>
<h4 id="原因与解决：-1"><a href="#原因与解决：-1" class="headerlink" title="原因与解决："></a>原因与解决：</h4><p>在开始拍摄的时候，再去创建connection并传递设备和拍摄方向，有利于视频获取oritation，自然而然的横着拍摄也会竖着播放，但是问题在于connection的建立产生较大的链接，引起视频抖动，此抖动将被录制进入视频文件中。于是我采取在初始化input的时候就把connection就增加进去，当开始拍摄的时候不会发生抖动，但是牺牲的是视频的oritation需要自己根据用户拍摄的方向去手动修改视频方向。</p>
<h3 id="3、视频方向混乱："><a href="#3、视频方向混乱：" class="headerlink" title="3、视频方向混乱："></a>3、视频方向混乱：</h3><h4 id="现象：-2"><a href="#现象：-2" class="headerlink" title="现象："></a>现象：</h4><p>背面摄像头拍摄，home键在下，拍摄出来的视频文件，在播放的时候，底部在手机右边，而不是底边，一次类推，home键在底部与视频的底部角度成90垂直关系。</p>
<h4 id="原因与解决：-2"><a href="#原因与解决：-2" class="headerlink" title="原因与解决："></a>原因与解决：</h4><!--0-->
<pre><code>self.videoOutPut = [[AVCaptureVideoDataOutput alloc] init];
NSDictionary * outputSettings = [[NSDictionary alloc] initWithObjectsAndKeys:[NSNumber numberWithInt:kCVPixelFormatType_32BGRA],(id)kCVPixelBufferPixelFormatTypeKey, nil];
[self.videoOutPut setVideoSettings:outputSettings];

//必须
if ([self.session canAddOutput:self.videoOutPut]) {
    [self.session addOutput:self.videoOutPut];
}

//先于
self.videoConnection = [self.videoOutPut connectionWithMediaType:AVMediaTypeVideo];
self.videoConnection.enabled = NO;
[self.videoConnection setVideoOrientation:AVCaptureVideoOrientationPortrait];
</code></pre><h3 id="4、横着拍摄的视频横着播放："><a href="#4、横着拍摄的视频横着播放：" class="headerlink" title="4、横着拍摄的视频横着播放："></a>4、横着拍摄的视频横着播放：</h3><h4 id="现象：-3"><a href="#现象：-3" class="headerlink" title="现象："></a>现象：</h4><p>横着拍摄的视频，放的时候是竖着的。</p>
<h4 id="原因与解决：-3"><a href="#原因与解决：-3" class="headerlink" title="原因与解决："></a>原因与解决：</h4><p>因为上面解决视频抖动，导致不能直接设定拍摄时候的视频方向，从而需要根据手动的拍摄方向去修改视频的视图的方向。<br>考虑到用户可能锁住屏幕旋转，于是就CMMotionManager获取重力方向来判断，在VC出现或者开始拍摄的时候开启，在VC退出或者拍摄完成的的时候关闭。获得方向后，在视频的写入里直接修改方向即可。</p>
<!--0-->
<pre><code>[videoWriterInput setTransform:CGAffineTransformScale(CGAffineTransformMakeRotation(-M_PI_2), 1.0, 1.0)];
</code></pre><h3 id="5、录制视频有右边和底边绿色线条："><a href="#5、录制视频有右边和底边绿色线条：" class="headerlink" title="5、录制视频有右边和底边绿色线条："></a>5、录制视频有右边和底边绿色线条：</h3><h4 id="现象：-4"><a href="#现象：-4" class="headerlink" title="现象："></a>现象：</h4><p>手机全屏录制的时候，设置视频输出宽度为手机的宽高，当宽高为基数的时候视频录制里面会出现绿色线条。</p>
<h4 id="原因与解决：-4"><a href="#原因与解决：-4" class="headerlink" title="原因与解决："></a>原因与解决：</h4><p>不知道原因，神奇的bug，参照着段子的视频方法解决的，直接修改视频输出宽高为偶数。</p>
<!--0-->
<pre><code>NSInteger videoWidth = [[NSNumber numberWithFloat:self.view.frame.size.width] integerValue];
NSInteger videoHeight = [[NSNumber numberWithFloat:self.view.frame.size.height] integerValue];
if (videoWidth % 2 == 1) {
    videoWidth = videoWidth - 1;
}
if (videoHeight % 2 == 1) {
    videoHeight = videoHeight - 1;
}
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/程序开发/">程序开发</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 东境
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: undefined,
		animate: undefined,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






  </div>
</body>
</html>